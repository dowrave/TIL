## 가설 검정

### 흐름
1. 연구 관찰
2. 실험 주제 / 문제 발견
3. 귀무 / 대립 가설 설정
4. 유의 수준 설정, 검정 통계량 선택
5. 실험 설계 및 진행
6. 표본 데이터 취합
7. 분석 및 결론 도출
8. 1) 귀무 가설 기각
8. 2) 대립 가설 기각 -> 필요한 경우 `3.`으로 돌아감
9. 보고 및 의사 결정

- 연구자가 문제나 실험 주제를 발견하면 새롭게 주장하기 위한 가설을 설정하게 된다.
- **귀무가설/영가설($H_0$) : 현재 사실로 받아들여지고 있는 잠정적인 진술**
- **대립가설/연구가설($H_1$) : 연구자가 주장하는 진술**

#### 통계적 가설
각 가설에서 어떤 수치의 평균값 $\mu_0, \mu_1$ 등을 이용하면 가설을 수치에 대해 나타낼 수 있다. 이를 통계적 가설이라고 함.

- 통계적 가설을 나타낼 때 주의할 점
1. 가설은 모집단에 대한 기술이기 때문에 모수에 대한 기호를 사용해야 한다.
2. 등호 표현 : 부등호가 없으면 등가설(Non-directional Hypo~), 있으면 부등가설(Directional Hypo~이라고 한다
	- 부등가설(부등호O)에서의 등호는 귀무가설에 포함된다

- 등가설은 부등호가 없기 때문에 두 값이 서로 다른지를 확인하므로 양방적 검정이라고 하며, 부등가설은 일방적 검정이라고 한다.

#### A/B Test
- 실무에서 사용되는 가설 검정.
> ex) 광고에 A가 나은지 B가 나은지 어떻게 알 수 있을까? 
> 게임에 새로운 기능을 추가하려고 하는데 추가하는 게 나을까 아닐까?

- 어떤 것이 뛰어난지 검정(Testing) 과정을 거친다면 선택으로 인한 위험, 손실을 최소화할 수 있을 것이다. 

> 기존에 천연 세제라고 쓰다가 친환경 세제로 바꾸고 싶다(유입 키워드가 친환경이 많아서)
> 귀무 가설 : 두 문구의 클릭률 차이가 없다 
> 대립 가설 : 친환경 클릭률이 더 높다
> 통계적 가설 : H0 : P(0) = P(1) / H1 : P(0) < P(1) 

## 유의 수준
- 가설 설정 후 **실험 진행 전, 유의 수준과 검정 통계량을 설정해야 한다.**
- **가설검정을 하는 이유는 결국 어떤 가설을 채택할 것이냐를 결정**하기 위함인데, 이 결정은 모집단의 모수를 추리할 뿐 **결정 자체가 맞는지 틀린지를 알 수 없다.**

이 불확실성은 결정이 잘못되었을 때 
- 어떤 오류가 있는지
- 오류에 빠질 확률은 어느 정도인지
- 각 오류에 어느 정도의 심각성이 있는지 
파악함으로써 불확실성의 정도를 구체화할 수 있다.

- 그러면 케이스를 4가지로 나눌 수 있다.
|                   | 진리 : 귀무가설 | 진리 : 대립가설 |
| ----------------- | ------------- | ------------- |
| 채택 : 귀무가설 | $1-\alpha$     | **Type II Error($\beta$)** |
| 채택 : 대립가설 | **Type I Error($\alpha$)** | 검정력($1-\beta$) |

어떤 의사결정이든 오판 확률이 존재한다. 따라서 아래 이슈가 중요해진다.
- 오판이 얼마나 심각한가
- 오판을 내릴 확률을 어디까지 허용할 것인가

#### 1종 오류 (Type I Error)
- **$\alpha$ , 유의 수준(Significant Level) 모두 동의어**
- **대립가설 채택 시 선택이 틀릴 확률**
- 다르게 생각하면 대립가설을 채택하더라도 이 정도의 오류는 허용할 수 있다는 의미
- 일반적으로 **0.05**나 **0.01**로 설정하며, 유의수준 = 의사결정 기준이므로 실험 계획 전에 기준을 정한다.

#### 2종 오류(Type II Error)
- $\beta$
- **귀무가설 선택 시 선택이 틀릴 확률**

#### 검정력
- 대립가설이 실제로 맞는 상황에서 연구자가 대립가설을 채택할 확률

## 통계 검정 방법 선택하기

### 양적 변수 
- 표본 크기 : $n_1, n_2$
- 표본 평균 : $\bar{X}$
- 표본 표준편차 : $s_1$

#### 1. 표본의 개수 1개
- 모집단에서 추출된 표본의 평균과 연구자가 설정한 수를 비교할 때 이용

##### 1. 단일표본 t 검정
- 모집단의 표준편차를 모를 때 사용
- 표준오차는 표본표준편차를 사용, `자유도`에 따른 t-분포에서 기각값을 이용함

> 자유도(Degree of Freedom : DF)
> 주어진 조건에서 제약없이 자유롭게 결정할 수 있는 수
> ex) 5개의 데이터와 이들의 평균값이 있다면 4개의 데이터 값이 결정되었다면 나머지 1개의 값은 자동으로 결정되게 됨
> 이 때 평균을 `제약`이라고 표현하며, 5개 중 4개는 아무런 `제약 없이` 결정된다.
> 이를 확장하면 **표본 n개로 모수를 추정할 때 자유도는 `n-1`이 됨.**


##### 2. 단일표본 z 검정
- 모집단의 표준편차를 알 때 사용
- 귀무가설을 기준으로 표집분포를 이용해 Z 통계값을 계산함

#### 2. 표본 개수 2개
- 두 모집단의 속성(평균)의 유사성을 비교하는 검정통계법
- 두 모집단을 대표하는 두 표본이 종속적인지 독립적인지에 따라 상황이 나뉜다.

##### 1. 두 종속표본 t 검정
- 두 표본이 서로 종속적이고, 두 모집단의 표준편차를 모를 때 사용함
- ex) 형제자매, 쌍둥이 // 사전, 사후 검사
	- 2개의 표본이 서로 짝이 지어진 것이므로 두 표본에 대한 차이의 검정으로 진행됨.
- 크기 n인 2개의 표본이 있더라도 두 표본의 차이를 계산하면 자유도는 n-1이 됨(차이라는 제약이 있기 때문에)

##### 2. 두 종속표본 Z 검정
- 두 표본이 서로 종속적이고, 두 모집단의 표준편차를 알 때 사용함
- 흔하지 않음
- 두 표본이 상관되어 있기 때문에 상관계수가 필요함

##### 3. 두 독립표본 t검정
- 두 표본이 독립적, 모집단의 표준편차 모름
- 두 표본의 표준편차로 모집단의 표준편차를 추정해양 함
- 표준오차 계산 시 모집단의 표준오차를 추정해야 함
	- 방법 1 : 두 모집단의 분산이 같다(등분산가정)
		- 각각의 표준편차를 추정하는 대신 두 표본의 표준편차를 통합해 표준오차를 계산함 -> `통합분산`$s^2_p$
		- 이 때 자유도는 1번째, 2번째 표본의 자유도가 합쳐진 값이 된다.
	- 방법 2 : 두 모집단의 분산이 다르다

##### 4. 두 독립표본 Z 검정
- 두 표본이 독립적, 모집단의 표준편차 동일
- 표본이 2개이므로 평균과 표준오차 계산 시 두 표본의 차이값을 계산한다는 점이 다르다.

> 막 써갈겨도 잘 모르겠어서 용어들만 남겨놓는다. 자세히 다루지 않은 이유가 있지 않을까?

#### 3. 표본 개수 2개 이상 - 분산분석 ANOVA
- 3개 이상의 모집단 비교 시 각 모집단에서 추출된 표본의 **집단 간 변화량**과 **집단 내 변화량**을 비교해야 한다. **변화량은 분산을 통해 알 수 있다.**

> 예시 ) 최대한 동일한 구성으로 모은 A, B, C라는 집단이 있더라도, 각 집단 내에서도 차이가 있을 것이다.  
> 이들을 대상으로 실험을 했고 그 실험이 효과적이라고 가정한다면, **집단 내의 변화량보다는 집단 간의 변화량이 더 클 것이다.**

- 이러한 변화량을 분산으로 계산하기 때문에 이 방법을 **분산분석(ANOVA : ANalysis Of VAriance)** 이라고 한다.
- 피셔가 고안한 **F분포**로 검정하며, F분포는 **집단 간의 분산과 집단 내의 분산 비율에 대한 분포**를 의미한다.
- 즉, **`집단 간의 분산 > 집단 내의 분산`일수록 집단 간의 차이가 있다**

- **분산 분석은** Z 검정, t 검정, F 검정의 **등분산가정이 충족되는지 확인하는 데 쓸 수 있다.**
	- 예시 ) 두 모집단의 분산이 같은가 확인하고 싶을 때 귀무가설과 대립가설을 설정하고, 표본에서 분산을 계산한뒤, F = (표본분산1) / (표본분산2) 을 계산한다.

##### 1. 일원분산분석(One Way Analysis of ANOVA)
- 1개의 독립변수를 2개 이상의 집단으로 나눠 집단마다 종속변수의 평균을 계산해 집단마다 차이가 있는지 검정한다.

> 예시) 회사 웹사이트 오후 12~1시 방문자를 대상으로 웹사이트 배경색(독립변수)을 다르게 적용할 경우, 머무는 시간(종속변수)이 차이가 있는지 검정

- 조건
	- 표본은 독립적
	- 집단별 모집단의 표준편차가 동일
	- 표본은 정규분포인 모집단에서 추출되어야 함
	- 종속변수는 연속적인 값을 가지는 양적변수

- 조건을 만족하는 경우 

1. 가설 설정
	- 귀무가설 : 모든 집단 평균이 같다
	- 대립가설 : 1개 이상의 집단 평균이 다른 집단 평균과 다르다
2. 유의수준 설정
3. 실험을 통해 얻은 값으로 $F = \frac{MS_b}{MS_W}$ 값을 계산함
	- $MS_B$ : 집단 간의 편차제곱평균 값(between)
	- $MS_W$ : 집단 내의 편차제곱평균 값(within)

- 주의할 점 
	- 대립가설 채택 시 어떤 집단이 다른지 알 수 없음. 대립 가설이 맞다는 거만 알 수 있음
	- 여기서 추가로 어떤 집단이 다른지 알고 싶다면 대비(Contrast)를 이용한 통계 방법인 사후비교분석(Post-HOc Comparison Analysis)을 이용한다.

##### 2. 이원분산분석 : Two-Way Analysis of ANOVA
- 독립변수가 2개일 때 사용됨
- 조건
	- 집단별 분산 동일
	- 종속변수에 대한 모집단 분포는 정규분포
	- 표본은 독립적으로 모집단에서 추출

- 독립변수가 2개이므로, 2가지 방법으로 가설 검정 설계를 할 수 있다.

1. **교차설계(Crossed Design)**

> 예시 
> 독립변수 A : 웹사이트 배경색
> 독립변수 B : 웹사이트 문구
> 종속변수 : 방문자 접속 시간

- 이 때 알 수 있는 건 
	- 독립변수 -> 종속변수 에 대한 작용 이외에도, 
	- 독립변수 **2개를 동시에 바꿨을 때 종속변수에 영향을 주는지의 `상호작용 효과(Interaction Effect : AB)`**도 알 수 있다. 

- 가설 설정
	- 독립변수 A 귀무가설 : 배경색은 방문 시간에 영향을 주지 않는다
	- 독립변수 B 귀무가설 : 메인 문구는 방문 시간에 영향을 주지 않는다
	- 상호작용 A&B 귀무가설 : 배경색과 메인 문구의 상호작용은 접속시간에 영향을 주지 않는다

2. **내재설계(Nested Design)**

> 예시 2
> A : 성별
> B : 나이
> 종속 : 접속 시간

- 이 경우는 실험자가 원하는 대로 A, B의 독립변수를 바꿀 수 없잖음? 
- 대신 한 독립변수를 고정한 채 다른 독립변수에 대한 귀무가설을 세울 수 있음 : 이를 내재설계라고 함

- 가설 설정
	- 남성 귀무가설 : 남성의 경우 20대와 30대의 방문 시간은 차이가 없다
	- 여성 귀무가설 
	- 20대 귀무가설 : 20대의 경우 남성과 여성의 ~
	- 30대 귀무가설 

#### 4. 표본이 범주 변수

##### 1. 단일표본 비율 검정 Z test for Proportion
- **비율** : 모집단의 크기에서 특성을 지닌 대상의 수 $p = \frac{x}{n}$
	- $p$는 모집단의 모수 기호
	- $p_0$은 귀무가설에서 얻은 비율

- 표본의 경우, 예/아니오로 대답할 수 있는 특성인 경우 이항분포를 가진다
	- 이 떄 $np$와 $np(1-p)$ 값이 **5보다 크다면 Z 검정**을 사용할 수 있다.
	- $Z = \frac{\hat{p} - p_0}{\sigma_{\hat{p}}}$
		- $\hat{p}$ : 표본에서 얻은 비율
		- $p_0$ : 귀무가설에서 설정한 비율
		- $\sigma_{\hat{p}}$  = $\sqrt{\frac{p_0(1-p_0)}{n}}$ : 표준오차


##### 2. 두 독립표본 비율 검정 Two Samples Z test for Proportion
- 독립적으로 추출된 두 표본의 비율이 차이가 있는가를 검정함

- 귀무가설 : 두 집단 간의 비율은 같다
- 대립가설 : 두 집단 간의 비율은 다르다
- 뭐가 어쩌구 저쩌구 있는데 대충 Z 검정을 쓸 수 있고 집단 간의 비율 차이를 쓰고..


##### **3. 카이제곱검정(Chi-Squared Test)**
$\chi^2$ 분포는 모집단 평균이 $\mu_r$이고 분산이 $\sigma^2_\gamma$인 모집단에서 k개의 표본을 독립적으로 추출했을 때, 각 값을 표준정규분포로 표준화한 후 제곱해서 더해 만들어진 분포임

$$
\chi^2 = \Sigma^k_{i=1}\left(\frac{Y_i - \mu_\gamma}{\sigma_Y}\right)^2
$$
- 동질성 : 여러 모집단에서 각 표본을 추출했을 때 각 모집단의 비슷한 정도 검정
- **상관성** : **하나의 모집단에서 하나의 표본을 추출했을 때 표본을 구성하는 변수끼리 관계가 있는지**를 검정 
등에 사용된다.

> 예시1 - 동질성 연구
>  - 온라인 쇼핑몰 프로모션 -> 성별은 참여도와 상관이 있는가?
> 대립가설 : 프로모션 참여 남녀 비율은 다르다
> 귀무가설 : 프로모션 참여 남녀 비율은 같다
> 대상 : 각각 200명

- 이 때 아래와 같은 표를 그릴 수 있으며 이를 `IxJ 분할표(Contigency Table)`라고 한다.
|                 | 남  | 여  | 합계 |
| --------------- | --- | --- | ---- |
| 프로모션 참여   | 98  | 131 | 229  |
| 프로모션 비참여 | 102 | 69  | 171  |
| 합계            | 200 | 200 | 400     |
- 각 칸의 도수를 `획득 도수`$f_{ij}$라고 한다. (ex : $f_{12}$는 131임)

- 귀무가설을 채택하기 위해선 전체 참여 비율인 229/400 = 57.2%가 남, 녀 모두에게서 나타나야 한다.
	- 이 때 **기대도수**($F_{ii}$)를 설정할 수 있는데, 귀무가설이 성립할 시 각 남/녀에 들어가는 숫자이다.
	- 참여 : 남/녀 모두 200 *  57.2%  = 114.5 ($F_{11}, F_{12}$)
	- 비참여 : 남/녀 모두 200 * 42.8% = 85.5($F_{21}, F_{22}$)

- 이 값들을 이용해 카이제곱 통계값을 계산할 수 있다.
$$
\chi^2 = \Sigma_{i=1}\Sigma_{j=1}\frac{(f_{ij}-F_{ij})^2}{F_{ij}} = 11.12
$$
- 이 값과 사전에 설정한 **임계치**를 비교해 결론을 내리면 된다.
- 카이 제곱의 경우 임계치는 자유도에 따라 달라지는데,  $(I-1)(J-1)$로 계산되어 1이고, 유의수준이 0.05일 때 임계치는 3.84가 된다.
- 임계치값은 파이썬에서 이렇게 구할 수 있음.
```python
import scipy.stats
scipy.stats.chi2.ppf(1-0.05, 1) # 유의수준 0.05, 자유도 1
# 3.84
```

> 예시2 - 상관성 연구
> 500명, 가설은 위와 동일

|                 | 남  | 여  | 합계 |
| --------------- | --- | --- | ---- |
| 프로모션 참여   | 67  | 194 | 261  |
| 프로모션 비참여 | 71  | 168 | 239  |
| 합계            | 138 | 362 | 500  |

- `예시 1`과  표본 개수를 빼면 차이가 없어 보임 : 실제로 기대 도수 구하고 카이제곱검정 이용해서 구하는 방식이기 때문.

- 동질성 연구 : 연구하고자 하는 종속변수(프로모션 참여 여부)가 여러 모집단에서 유사성이 있는가

$$
H_0:P_{ij} = P_{ij}^{`} \\
$$
1. $P_{ij}$ : 1번째 모집단
2. $P_{ij}^{`}$ :2번째 모집단의 칸 ij 비율

- 상관성 연구 : **하나의 모집단에서 변수별로 집단을 나눠 변수의 연관성을 체크**
$$
\begin{matrix}
H_0 : \phi = 0 \\
\hat{\phi} = \sqrt{\frac{\chi^2}{n}}
\end{matrix}
$$
$\phi$는 상관계수를 말하며, 카이제곱값으로 상관계수를 추정함
$$
\chi^2 = \Sigma_{i=1}\Sigma_{j=1}\frac{(f_{ij}-F_{ij})^2}{F_{ij}}
$$
---
- 여기까지가 모수 통계를 통한 가설 검증 방법임

- 모수 통계에서는 가정 조건을 확인해야 함
- Z-검정, t 검정, F 검정에서 공통으로 체크해야 할 것은
	**1. 양적 변수**
	**2. 모집단 분포는 정규 분포**
	**3. 모집단이 여러 개라면 분산이 같아야 함**
- Z검정은 모집단의 표준편차를 알고 있을 때 쓰며, 그렇지 않다면 표본에서 추출해 t-검정을 사용해야 함

- 카이제곱검정도 조건이 있음
	- 각 칸은 0 이상
	- 각 칸은 독립적
	- 기대 도수 계산 시 5 이하의 값이 전체 칸 수의 20%가 넘으면 안됨 등.

- **실무에서는 모집단의 정보를 얻는 경우는 흔치 않아서 업무에서는 가설 검정을 사용하지 않는 경우가 많다.** 그러나 **가설 검정을 이해하고 있는 것은 중요**하다.

### 가설검정 결론 내리기
- 미리 설정한 **유의수준$\alpha$, 임계치를 기준으로 실험을 통해 얻은 값인 p-value나 검정 통계량이 어느 영역에 있는지를 바탕으로 결론**을 내리면 된다.
- 영역
	- 기각역 : 귀무가설을 거절
	- 채택역 : 귀무가설을 지지

- 유의수준, 임계치는 귀무가설의 기각 여부를 구준하는 기준값이다.
	- **유의수준** : 실제로 귀무가설이 맞지만 귀무가설이 틀렸다고 오판할 확률 값(Type I Error, $\alpha$)
	- **임계치(=기각값)** : 검정 통계량에서 사용되었던 분포에서 유의 수준에 해당하는 통계값

- 가설에 부등호가 있다면 유의수준은 단방향으로 고려되어야 한다.
- 부등호가 없다면 양방향으로 고려되어야 한다.

#### 유의확률(p-value)
- 임계치를 기준으로 구한 검정 통계량 = 유의 확률(p-value)이다. 
- **p-value < 유의수준** : 기각역에 있는 것으로, 귀무가설을 기각한다.
- **p-value > 유의수준** : 채택역에 있는 것으로, 귀무가설을 지지한다.

#### 근데 p-value가 유의수준보다 조금 크면 어떡함?
- 실제로 미국 통계 학회에서 낸 2016년 논문에 따르면
	- 유의수준을 0.05로 이용하는 이유
	- **유의수준과 유의확률만의 단순 비교만으로 예/아니오의 의사결정이 서두를 수 있다**는 걸 지적함
- 대신 실험이 어떻게 구성되었는지, 데이터가 어떻게 측정되었는지, 가정이 충족되었는지 등을 전반적으로 고려하는게 중요하다고 함
- 또한, 우도 비율 검정(Likelihood Ratio Test), 의사결정이론(Decision Theoritic Modeling), False Discovery Rate(1종 오류 조정) 등 다양한 방법의 접근이 필요하다고 지적함

---

### 실습
- A/B 테스트, 무작위 선별 별도로 1500명, 클릭 수 139(친환경) vs 118(천연)
- 두 그룹에 대한 비율을 구하는 것이니 두 독립표본 비율 검정을 이용함

- Python에서는
```python
from scipy import stats
from statsmodels.stats.proportion import proportions_ztest

# converted : 클릭 수
# sizes : 전체 표본 수 

z_score, z_score_pr = proportions_ztest(converted, sizes, alternative = 'larger')
```
- 을 통해 `z_score = 1.370`, `확률 = 0.085`을 얻었다.

- 등가설 검정(부등호가 없음)이므로 유의수준은 양방향으로 고려된다.

- 8%는 유의 수준 5%보다 높은 값이므로, 채택역이며 귀무가설을 지지하는 결론이 나온다.
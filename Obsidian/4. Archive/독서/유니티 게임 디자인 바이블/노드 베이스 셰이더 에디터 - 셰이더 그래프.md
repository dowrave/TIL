1. [[#개요와 특징|개요와 특징]]
2. [[#렌더 파이프라인 설정|렌더 파이프라인 설정]]
3. [[#생성|생성]]
4. [[#셰이더 그래프의 기본 조작|셰이더 그래프의 기본 조작]]
5. [[#기본적인 샘플 셰이더 만들기|기본적인 샘플 셰이더 만들기]]
6. [[#샘플 셰이더 기능 추가|샘플 셰이더 기능 추가]]
7. [[#유니티에서 셰이더 동작시키기|유니티에서 셰이더 동작시키기]]
8. [[#셰이더 저장 및 유니티에서 확인하기|셰이더 저장 및 유니티에서 확인하기]]
9. [[#셰이더에 관한 기본 사고방식|셰이더에 관한 기본 사고방식]]
	1. [[#셰이더에 관한 기본 사고방식#1. 색은 0 ~ 1로 생각한다.|1. 색은 0 ~ 1로 생각한다.]]
	2. [[#셰이더에 관한 기본 사고방식#2. 색, UV, 법선 각도, 공간 좌표 모두 관계 없이 수치로 취급한다|2. 색, UV, 법선 각도, 공간 좌표 모두 관계 없이 수치로 취급한다]]
10. [[#노드 종류 소개|노드 종류 소개]]
11. [[#마스터 노드의 종류|마스터 노드의 종류]]
12. [[#예제 - 수면 애니메이션 만들기|예제 - 수면 애니메이션 만들기]]



유니티 에디터에서 동작하는 노드 기반의 셰이더 에디터. 
환경에 의존하지 않는 유연한 셰이더도 만들 수 있지만, URP나 HDRP에서 작업해야 한다. 

## 개요와 특징
- `노드Node`라고 불리는 기능 블록들을 선으로 연결해서 만든다. 
- `셰이더`는 엔지니어가 스크립트를 기반으로 만들지만, `셰이더 그래프`는 디자이너라도 코딩 없이 실시간으로 확인하면서 직접 셰이더를 만들 수 있다.  `보로노이 도면`이나 `노이즈` 등의 표현도 간단하게 구현할 수 있어 **최소한의 필요 지식만으로 뛰어난 표현을 할 수 있다. 다만 본격적으로 사용하려면 수학 지식이 필요한 경우도 있다.**
- 노드의 종류가 많기 때문에 자주 사용하는 노드부터 조금씩 기억해나가면 됨.

## 렌더 파이프라인 설정
1. `URP` 혹은 `HDRP` 패키지를 설치한다
2. `ShadeGraph` 패키지도 설치한다.
> 이들의 버전 관리는 양쪽 모두에 맞춰서 계속 최신화해줄 필요가 있지만, URP의 경우는 셰이더 그래프 버전에 신경쓰지 않아도 괜찮다.

3. 렌더 파이프라인 설정 변경 
- 책이랑 내용이 조금 달라서 정리해둠 : `Project Settings - Graphics` 에서 `Scriptable Render Pipeline Settings`에 `UniversalRenderPipelineAsset`을 등록하면 됨

## 생성
`Project` 탭에서 우클릭 - `create - Shader Graph - URP` 안에 항목들이 있음
- `Unlit Graph` : 라이트를 사용하지 않는 셰이더
- `lit Graph` : 라이트 사용 셰이더 *책과 다름*
> 책에는 다른 항목인 VFX Shader Graph나 Sub Graph 등도 있다고 뜨는데, 내 경우는 그것들이 보이진 않음. 

![[Pasted image 20241120164810.png]]
> 셰이더 그래프의 모습으로, 크게 `블랙보드`, `메인 에어리어`, `메인 프리뷰`, `마스터 노드`가 있다.

- `블랙보드` : 셰이더 패스나 외부에서 수치를 조정할 수 있는 속성을 등록하는 부분. 좌측 하단에 있음.
- `메인 에어리어` : 노드들을 조합해 셰이더를 만드는 영역
- `메인 프리뷰` : 최종적인 셰이더의 형태를 실시간으로 표시, 오류 발생시 핑크색으로 뜬다.
	- 우클릭해서 나오는 컨텍스트 메뉴에서 다양한 형태를 선택할 수 있다.
- `마스터 노드` : 메인 에어리어에 있는 마스터 노드에 선을 연결해서 최종적인 형태가 된다.
	- 여러 종류가 있으며, 처음 셰이더를 만들 때의 선택에 따라 출력 항목이 달라진다.

- 셰이더 경로 설정하기
![[Pasted image 20241120165026.png]]
`블랙보드`의 화면으로, 여기서 `custom`이라고 표시된 문자가 셰이더 경로가 된다.

## 셰이더 그래프의 기본 조작
- UI 보면 알 수 있는 내용은 설명 안함

- `스크롤`
	- `메인 에어리어`에서 휠 클릭 후 드래그
	- `Alt` + 마우스 좌측 클릭 후 드래그
- `확대 / 축소`
	- `메인 에어리어`에서 마우스 휠 회전
- `모든 노드가 화면에 보이도록 표시`
	- `A`키는 노드 전체를 표시
	- `F`키는 현재 선택한 노드를 중심으로 확대/축소
- `노드 이동`
- `속성 변경`
	- 노드 우클릭 후 컨텍스트 메뉴에서 수행
	- 필드 / 노드 / 마스터 노드 등등에서 각각 다른 요소가 나타남
- `노드 새로 만들기`
	- 메인 에어리어의 빈 곳을 우클릭해서 만듦
	- 이미지, 서브 그래프를 프로젝트 창에서 드래그해서 메인 에어리어로 옮기는 것도 가능
- `여러 노드 선택`
	- 드래그 
	- Ctrl + 노드들 클릭
- `노드 연결`
	- 타입이 맞는 아웃풋 / 입력 간의 드래그
	- 채널 수가 다른 경우, 
		- 많은 쪽에서 적은 쪽으로 연결할 때 일부가 잘려나가긴 해도 연결할 수 있다.
			- 예를 들면 `Vector2` -> `Vector1`로 연결한다면 X값만 전달됨. 지금은 `float`로 쓸 거임 아마
		- 적은 쪽에서 많은 쪽으로 연결할 경우, 추가되는 필드들은 기존 필드와 같은 값으로 채워진다.
- `노드 간 연결 해제`
	- 연결선 선택 후 우클릭 - Delete 클릭
	- 키보드의 `Delete` 키 클릭
- `노드 프리뷰 표시/비표시`

## 기본적인 샘플 셰이더 만들기
1. `Texture 2D Asset` 노드와 `Sample Texture 2D` 노드를 생성 후 연결
	- `Texture 2D Asset` : 이미지를 로딩하기 위한 노드
	- `Sample Texture 2D` : 이미지에서 색상을 추출하기 위한 노드

2. 텍스쳐의 색상을 표시하기 위해, Sample Texture 2D의 RGBA 노드를 마스터 노드의 `Base Color`에 연결 (책과 버전과 지금 버전이 다른 듯)
- 아웃풋이 4채널, 인풋이 3채널로 이 경우 Alpha 값이 버려진다. 이를 위해 `Sample Texture 2D`의 `A`를 `Fragment`의 `Alpha`에 연결해준다
> - 내 경우 처음에 마스터 노드에 `Alpha`가 없었는데, Graph Inspector - Transparent로 변경하니까 Alpha값이 나오기 시작함. 근데 이 설명이 바로 아래에 나온다.

3. 현재 상태에서는 반투명 상태 표시가 안되는데, `Unlit Graph` 셰이더의 초기 설정은 불투명한 오브젝트용이다. 그래서 이를 **반투명용으로 전환**한다. `Graph Inspector`의 `Opaque` -> `Transparent`로 변경.
	- `Alpha Clip Threshold = 0`으로 설정해서 모든 알파값을 보이게 한다.
> 또, 책에서는 `Alpha Clip Threshold`가 바로 보이지만 내 경우는 보이지 않는다. `Graph Inspector`에서 `Alpha Clipping`을 활성화하면 나타난다. 
> - Fragment를 우클릭해서 `Add Block Node`로 추가해줄 수 있지만, 이 방식으로는 해당 블록 노드가 활성화되지 않는다.
![[Pasted image 20241120170927.png]]
![[Pasted image 20241120170940.png]]
`Alpha Threshold` 값에 따른 이미지의 차이. 원본이 저런 뿌연 형태다.


## 샘플 셰이더 기능 추가
- 색상을 곱해서 블렌딩하는 기능을 추가한다. 표준 머티리얼에도 비슷한 기능이 있음.

1. `Color` 노드 추가, `MultiPly` 노드도 추가
2. 기존 `SampleTexture 2D`의 아웃풋과 `Color` 노드의 아웃풋을 `Multiply`의 A, B에 각각 할당.
3. `Multiply`의 아웃풋을 `Fragment`의 `Base Color`에 할당.

![[Pasted image 20241120171351.png]]

- 이 상태로는 `Color` 노드의 `Alpha`값이 반영되지 않는다. **`Color`의 알파 채널이 사용되지 않도록 노드가 연결되어 있기 때문**으로, 이를 반영하려면 아래의 설정을 추가로 해준다.

> 이게 궁금해서 따로 찾아봤다 : 4채널 간의 연산인데 알파값은 따로 반영이 되지 않는 건가?
> - 일반적으로 `Multiply` 연산은 **색상의 조합**을 위해 사용하는 경우가 많다. 알파값까지 계산에 포함되면 꼬이는 경우가 잦았나 봄.
> - 이건 일반적인 그래픽 처리에 대한 관행이기도 해서, 알파 채널에 대한 연산은 별도의 연산, 혹은 블렌딩 과정에서 처리한다고 한다.
> **결론은 색상 간의 `Multiply`에서 알파값은 따로 처리하는 게 일반적이라는 것.**

1. `Split` 노드와 `Multiply` 노드를 추가함
2. `Split` 노드의 인풋에 `Color`의 아웃풋 노드를 연결
3. `Split` 노드의 아웃풋 중 `Alpha`만 새로 추가한 `Multiply` 노드에 연결
4. `Sample Texture 2D`의 기존 `Alpha` 아웃풋을 제거하고 새로 추가한 `Multiply` 노드에 연결
5. 새로 추가한 `Multiply`의 아웃풋 노드를 마스터 노드의 `Alpha`에 연결

![[Pasted image 20241120171726.png]]

이런 식으로 **알파값 연산은 각각의 색에서 별도로 분리해서 따로 처리한 다음, 뒤에서 다시 합쳐주는 방식으로 진행된다**는 건 꼭 알아두자!

## 유니티에서 셰이더 동작시키기
- 현재 상태에서는 이미지, 색상을 셰이더 그래프에서만 변경할 수 있다. 이를 다른 셰이더처럼 머티리얼에서 자유롭게 변경할 수 있게 만드는 과정이다.

- `Texutre 2D Asset 노드 선택` -> 메인 에어리어 우클릭 -> `Convert to` ->  `Property`

이러면 선택한 노드가 작아지고, 블랙보드에 노드의 상세 설정 내용이 표시된다.
![[Pasted image 20241120172535.png]]

- `Color` 노드도 마찬가지로 `Convert To Property`로 블랙보드에 등록한다. 
- 원래 상태로 되돌리고 싶다면 노드 우클릭 - `Convert To Inline Node`로 변경한다.

## 셰이더 저장 및 유니티에서 확인하기
- `Save Asset` 버튼으로 셰이더를 저장한다. 작업 내용은 주기적으로 저장된다.
- 이 셰이더를 유니티의 오브젝트에 붙여서 반영하려면, 프로젝트 창에서 `셰이더 선택 -> 우클릭 -> Create -> Material`으로 머티리얼을 만들 수 있다.
![[Pasted image 20241120172832.png]]
그러면 아까 블랙보드에 지정한 `ActiveStar`, `Color`을 유니티 인스펙터 상에서 설정을 바꿀 수 있게 된다.

## 셰이더에 관한 기본 사고방식

### 1. 색은 0 ~ 1로 생각한다.
- 0 ~ 255로 다루기도 하지만, 셰이더에서는 0~1의 값으로 취급한다.
- 이를 **벗어나는 값은 버리므로 표현하지는 못하지만, 정보 자체는 갖고 있어서 색상 합성 시의 계산 등에 이용**된다.
> 예제
![[Pasted image 20241120173254.png]]
 이런 이미지가 있을 때의 테두리에서의 흐릿한 부분의 변화를 보면
 1. 해당 부분들은 알파값이 0 ~ 1 사이를 가짐
 2. 근데 Subtract에서 0.5를 뺐으니 -0.5 ~ 0.5 를 가짐
 3. 마지막으로 Multiply에서 4를 곱했으니 -2 ~ 2를 가짐
하지만 실제로 보여지는 범위는 0~1이기 때문에, -2~0과 1~2가 된 값은 이미지에 나타나지 않아서 샤프하게 보이게 된다.

### 2. 색, UV, 법선 각도, 공간 좌표 모두 관계 없이 수치로 취급한다
- 모두 벡터를 쓴다는 얘기임 -> 그래서 3차원 이상의 벡터는 모두 색으로 간주할 수도 있다.
![[Pasted image 20241120173658.png]]
- `UV`는 세로, 가로의 0~1 그라데이션
- 법선 방향도 법선의 중심을 경곌 하는 극단적인 그라데이션 등등..

## 노드 종류 소개

- `Time` 노드 
![[Pasted image 20241120173755.png]]
- 시간을 얻는다. 애니메이션을 수행하는 메서드에선 반드시 필요하다.
- 특별한 이유가 없다면 `Time`을 쓴다.
- `Delta Time, Smooth Delta`는 프레임 사이 시간을 반환한다.

- `Float, Vector 2~4` 노드
- `Add, Subtract, Multiply, Divide` 노드
- `Color` 노드
	- `Mode`에서 일반 노드와 HDR 모드를 전환할 수 있다.
- `Texture 2D Asset` 노드
	- 이미지를 로드한다. 이 노드만으로는 색을 얻지 못해서 `Sample Texture 2D`노드를 함께 쓴다.
- `Sample Texture 2D` 노드
	- 색상을 채널 단위로 얻는다. `UV` 노드나 `Texture 2D Asset` 노드를 사용하지 않더라도 이 노드에서 직접 설정할 수 있다.
	- 노멀 맵을 로드할 때는 `Type`을 `Normal`로 설정해서 셰이더에서 올바르게 요철을 읽을 수 있게 한다. `Space`는 노멀 맵의 종류를 선택할 수 있다.
- `UV` 노드
	- 메시에서 UV를 얻는다.
	- 채널을 분해하면 흰색, 검은색의 그라데이션을 얻을 수 있다.
	- 채널로 UV0~3을 설정할 수 있으며, 1~3은 다중 UV를 사용할 때 유용하다.
> 이 UV라는 개념을 정확히 몰라서 따로 정리해둔다. [[셰이더 - UV]]
- `Position` 노드
	- 꼭짓점이나 프래그먼트의 위치를 얻는다.
	- 오브젝트나 카메라의 좌표, 글로벌 좌표 등 다양한 대상의 좌표를 얻기 위해 쓰인다.
- `Step / SmoothStep`
	- 입력값이 지정한 값 이상이면 1, 아니면 0을 출력하는 조건 분기로 사용한다.
	- `툰 셰이더` 같은 그라데이션이 명확한 칠하기에 쓰인다. `SmoothStep`은 색상의 경계를 더 부드럽게 한다.
- `Split`
	- 한 세트로 된 색상을 RGBA 각 채널로 분리한다.
	- 좌표도 XYZW로 간주해서 쓸 수 있다.
- `Lerp`
	- 입력값 T에 따라, 입력 A와 B 값 사이의 수를 반환한다.
	- T가 0에 가까울수록 입력 A에 가까운 값, 1에 가까울수록 입력 B에 가까운 값을 반환한다.
	- 모든 채널수에 대응한다.
- `One Minus`
	- `0 ~ 1` 사이의 값을 가진 입력값의 수치를 반전한 값을 반환한다.
	- 색을 입력하면 색이 반전됨.
	- 색의 반전 노드로 `Invert Color` 노드나 `Flip` 노드 등이 있지만 계산 결과가 다르다.
- `Absolute`
	- 절댓값이죠?
- `Fraction`
	- **입력값이 1을 넘으면 0으로 돌아가 반복되는 값을 반환한다. `Time`과 조합해서 쓴다.**

## 마스터 노드의 종류
- `마스터 노드` : 최종 연결 대상
	- 셰이더의 형태를 결정하며, 하나의 셰이더에는 반드시 하나의 마스터 노드가 있어야 한다.
	- 셰이더를 만드는 중 바꾸고 싶다면 Create Node에서 마스터 노드를 추가할 수 있다..
		- 이렇게 새로 만든 마스터 노드를 우클릭 해서 `Set Active`를 이용해 전환할 수도 있다.
> 는데 없다.

- PBR Master 노드.. 따로 안 보여서 스킵.

- **`Unlit`**
	- **빛을 사용하지 않는 셰이더 생성 시 사용.** 
	- **부하가 작아서 이펙트 등에 쓰인다.** 
	- 요소가 적어 초보자도 다루기 쉽다.
![[Pasted image 20241120175652.png]]
> `Vertex` : 꼭짓점 관련. 근데 이 꼭짓점이 뭔지 모르겠음.
> - 각각 위치, 법선, 접선 항목임.

- `Sprite Unlit, Sprite Lit`
	- 각각 라이트를 사용하지 않는 스프라이트 / 2D 라이트를 사용하는 스프라이트용 셰이더.

## 예제 - 수면 애니메이션 만들기
- 이미지 없이 움직이는 수면을 만들 수 있다!!
- 생성 : `Create - Shader Graph - Unlit`

1. `Voronoi` 노드로 수면의 기본 패턴을 만듦
	- 수면은 그물망 형태 같은 복잡한 모양이므로, 셰이더 그래프 노드에서 비슷한 형태를 만들어내는 방향으로 진행한다. 
	- `Voronoi` 노드를 만드는데, 이 노드는 세포막, 스테인드글라스 같은 패턴을 만드는 노드다. 
	- `Cell Density` 값을 적당히 높게 설정해 패턴 크기를 조정한다.
![[Pasted image 20241120180119.png]]
2. `Color` 노드로 색을 입히고, `Add`노드에 `Color`와 `Voronoi`를 연결함
3. `Smoothstep` 노드로 수면 무늬의 형태를 바꿔줌.
	- 이 노드는 입력값이 어떤 임계값을 기준으로 작거나 클 때 0 혹은 1을 반환하는 노드이며, 그 사이를 부드럽게 보완한 그라데이션을 유지한다.
	- 여기서는 `Voronoi`의 저 가운데 있는 점의 크기를 키우기 위해 사용한다.
4. 프리뷰를 `평면Quad` 으로 바꿔서 확인한다.
	- `Main Preview`를 우클릭하면 각도를 조정할 수 있다. 
	- 이 상태로도 큰 문제는 없어 보이지만, 수면은 기울여서 볼 때 반사율이 변하는 프레넬 반사 속성을 가지므로 수면이 변화하는 듯한 구조를 넣을 수 있다.
![[Pasted image 20241120180805.png]]

5. `Fresnel` 노드로 프레넬 반사를 추가한다.
	- 시각에 따라 폴리곤 표면의 반사율을 다르게 표현하는 노드이다. 가장자리일수록 희게 보인다. 
	- `Fresnel` 노드와 `Add` 노드를 추가, 이전에 만든 Add 노드의 아웃풋과 Fresnel 노드의 아웃풋을 이어준다.
	- `Fresnel` 노드의 `Power`는 `7.4`로 설정해준다.
![[Pasted image 20241120181223.png]]

6. `Tiling And Offset` 노드와 `Time` 노드로 수면을 **UV 스크롤**한다.
	- `UV 스크롤`은 구름이나 강, 불 이펙트 등을 만들 때 사용하는 고전적인 방식이다.
	- `Tiling And Offset` : UV 애니메이션을 수행하는 노드
	- `Time` : 시간을 얻는 노드
	- 이 2개의 노드를 `Veronoi` 노드에 연결한다.
	- `Time - Time`과 `Tiling And Offset`의 `Offset`읠 연결하고, `Tiling And Offset`의 아웃풋을 `Voronoi` 노드의 `UV`에 연결한다.
	- 이렇게 구성하면 우측 상단 - 좌측 하단으로 물이 흘러가는 듯한 애니메이션이 연출되는데, `UV`의 `U`값과 `V`값에 **`Time`으로 얻은 같은 수치를 각각 더하기 때문**이다.

7. `Vector2` 노드와 `Multiply` 노드로 수면의 UV 스크롤을 조정한다.
	- 여기서 `Vector2`의 `X, Y`에 따라 수면이 스크롤되는 방향을 바꿀 수 있다. 

8. `Multiply` 노드로 수면을 움직인다. 
	- `Voronoi` 노드의 `Angle Offset`을 바꾸면 모양 패턴도 바꿀 수 있다. 
	- `Time`을 새로 만든 `Multiply`에 연결하고, `Multiply`의 `Out`을 `Voronoi`의 `Angle Offset`에 연결한다.

9. 노드를 그룹화해서 관리한다
	- 1개의 노드를 선택 -> `Group Selection` 선택하면 해당 노드 밖에 테두리가 생기고 `New Group`이 생김

10. 수면 애니메이션을 완성한다.
	- 추가로 다양한 UV 스크롤을 시험하거나, Voronoi 이미지를 가공해 변형하는 작업 등이 있을 수 있겠다.
![[Pasted image 20241120182158.png]]


- `비주얼 이펙트 그래프Visual Effect Graph`는 유니티 에디터에서 동작하는 노드 기반의 이펙트 에디터이다. 
- 셰이더 그래프와 마찬가지로 `URP`나 `HDRP` 등의 렌더 파이프라인을 먼저 설치해야 한다. 

## VFX 그래프의 개요와 특징
- 실시간 비주얼 이펙트를 위한 도구.
- 노드 베이스로 이펙트를 만들고, GPU에서 실행되는 컴퓨터 셰이더로 연산한다.
	- GPU는 단순 계산을 병렬로 실행할 수 있어 화면 렌더링 처리처럼 단순 연산이 대량으로 필요할 때 위력을 발휘한다.
- VFX 그래프로 이펙트를 만드는 경우, `시스템`이라 불리는 생성 흐름을 따라 처리가 수행된다.
	- 연결된 `컨텍스트`로 구성, 각 컨텍스트에서는 파티클을 만들고 초깃값을 설정하고 프레임별로 변화를 계산해 화면에 표시한다. 
	- 컨텍스트에서는 `블록`이라 불리는 파츠를 사용해 각 파티클에 대한 다양한 계산을 수행한다.
![[20241121_135210.jpg]]
- `파라미터`는 블록에서 계산을 수행하기 위해 갖고 있으며, 노드를 블록에 연결함으로서 노드에서 계산된 값을 블록으로 전달해 이펙트 계산에 사용한다.
 - 이펙트 만들기 자체는 컨텍스트 내에서 블록을 조합하는 것만으로 간단히 할 수 있지만, 수학적인 지식을 활용해서 노드를 조합해야 하는 경우도 있다. 
 - `셰이더 그래프`와 마찬가지로 여기서도 사용할 수 있는 노드나 블록의 종류를 많이 알수록 표현 가능한 대상의 폭이 넓어진다.

## VFX 그래프 설치
- 예제는 HDRP를 이용해 만듦
- HDRP 내부에는 VFX 그래프가 포함되어 있지만, URP는 그렇지 않다. 따라서 **URP를 설치한 후, VFX 그래프 패키지`Visual Effect Graph`를 별도로 설치한다.**
	- 설치 후에는 `Edit -> Project Settings`에서 `VFX` 탭을 선택해서 관련 설정들을 확인할 수 있다. 

## VFX 그래프 애셋 만들기
 - VFX 씬을 만들고, 프로젝트 창에서 `SampleVFX`라는 `Visual Effect Graph` 파일을 만든 뒤, 하이어라키에 넣는다.
 - 씬에 VFX 이미지들이 나오는 모양을 볼 수 있음.

## VFX 그래프 창의 기능 및 기본 조작
- VFX 애셋을 더블클릭했을 때 나타나는 영역
- ![[Pasted image 20241121152718.png]]
1. `BlackBoard` : `New VFX`로 나타난 곳으로, 수치를 설정할 수 있는 속성을 정의한다. 이 속성은 외부에 공개할 수 있고, 인스펙터에서 설정한 값을 노드에 전달할 수도 있다.
2. 메인 에어리어 : 검은 공간으로, 노드를 조합하는 영역이다. 조합된 노드는 컨텍스트 내의 ㅂ르록으로 전달된다.
3. `시스템`
	- 파티클 생성부터 출력까지 일련의 흐름을 정의한다. 시스템에는 `컨텍스트`가 순서대로 연결되어 있으며, 각 컨텍스트에는 `블록`이라는 파츠를 설정해 기능을 추가할 수 있다. 


`컨텍스트`는 테두리선마다 다른 기능을 하며, 컨텍스트에 입력된 데이터 타입과 출력되는 데이터 타입을 의미한다.
- `Spawn`은 입, 출력 테두리선이 모두 녹색인데, 이는 `SpawnEvent` 타입을 의미한다. 같은 색으로 표시된 `Initialize`의 컨텍스트 입력에 전달할 수 있다.
- `Initialize` 컨텍스트의 출력은 `Particle` 타입을 가지며, 테두리는 주황색이다. 같은 색인 `Update`으로 연결할 수 있다. 
	- 데이터 타입이 같기 때문에 **윈도우 안에서는 `Initialize`부터 `Quad Output`에 연결할 수도 있지만, 시스템 안에 `Update` 컨텍스트가 없으면 이펙트가 출력되지 않음**에 주의한다.

### 창에서의 조작 방법
- `셰이더 그래프` 때와 크게 다른 건 없음. UI도 비슷하다. 이전에 A키(전체 보기)나 F키(요소를 중앙에 놓기) 같은 기능도 동일. 

### 메뉴 바 기능
> 지금은 책 때와 구성이 달라서 생략. 

- `Auto` = `Auto Compile`로, 설정이 바뀔 때마다 다시 컴파일한다.
	- 이펙트가 복잡한 경우 컴파일에 시간이 소요될 수 있으므로, `Auto`를 빼고 임의의 타이밍에 컴파일을 명시적으로 할 수 있는 듯.(다만 내 경우에는 그 Compile이 보이지 않는다)

### 그룹화, 라벨, 메모 기능
- 한국어는 직접 입력할 수 없다고 함
- 그룹화는 셰이더 그래프에서도 나왔음
- 라벨
	- 컨텍스트 이름과 블록 사이 공간을 더블 클릭하면 텍스트 필드가 표시된다.
![[Pasted image 20241121153649.png]]
- 메모
	- 메인 에어리어의 빈 공간에 `Create Sticky Note` 메뉴를 선택해서 메모를 만들 수 있음

## 컨텍스트 개요
- 이펙트의 기본은 `파티클`이며, 이를 만드는 처리를 담당한다. 
- 처음에 활성화되는 `Spawn, Initialize, Update, Quad Output`을 활용해 설정을 진행하는 것을 추천한다. 
	- 독자적인 컨텍스트를 만들 수도 있지만, 최종적으로는 **`생성 - 초기화 - 갱신 - 출력`이라는 순서로 연결**해야 한다. 이 중 **하나라도 없으면 이펙트가 나오지 않는다.**
- 여기선 다루지 않지만, 같은 애셋 파일에서 여러 시스템을 만들 수도 있다.

### Spawn
![[Pasted image 20241121153855.png]]
- 이펙트를 만드는 단계. 
- 프레임 별로 파티클을 만들거나, 일괄적으로 만드는 등 블록에 따라 생성되는 타이밍을 결정할 수 있다. 
- 만들 파티클 수를 이 컨텍스트에서 결정할 수도 있지만, 화면 내에 표시할 수 있는 수는`Initialize`에서 결정한다.

### Initialize
![[Pasted image 20241121153649.png]]
- 만들어진 파티클의 초기 설정을 한다. 
- 가장 중요한 건 **`Capacity` 설정**으로, 이 값에 따라 **화면에 표시되는** 파티클 수가 결정된다.
- 이 외에 파티클의 생성 위치를 결정하는 `Set Position`, 파티클이 사라질 때까지의 수명을 결정하는 `Set LifeTime`, 파티클이 날아 들어오는 속도를 결정하는 `Set Velocity` 등 **파티클의 동작 제어에 쓰이는 다양한 설정**을 할 수 있다.

### Update
![[Pasted image 20241121154204.png]]
- 만들어진 파티클에 대해 프레임마다 처리를 수행할 때, 필요한 블록을 추가한다.
- 기본 설정은 블록이 없으며, 임의로 추가할 수 있다.
- 여기서 추천하는 블록은 
	- **구체를 만드는 `Conform to Sphere`**
		- 지정한 반지름의 구체 표면에 파티클이 줄지어 운동하는 듯 표현하며, 인력과 속도를 변경해 움직임을 바꿀 수 있다.
	- **난기류의 움직임 `Turbulence`**
		- 기류에 포함된 파티클이 운동하는 모양으로, 에너지가 넘치는 모양이나 연기가 피어오르는 모습을 표현할 때 쓰인다.

### Quad Output
![[Pasted image 20241121154347.png]]
- 만들어진 파티클의 위치, 크기, 색상 등의 정보를 기반으로 화면에 출력하는 컨텍스트.
- 디폴트는 `사각형 폴리곤Quad`에 텍스처 이미지가 적용된 형태로  출력된다.
- 지정된 블록 설명
	- `Orient : Face Camera Plane` 
		- 폴리곤용
	- `Set Size over life`
		- 만들어질 때부터 사라질 때까지의 크기 곡선
	- `Set Color over Life`
		- 만들어질 떄부터 사라질 때까지의 색 변화
- 사용 예시
	- **에너지** 같은 추상적인 이펙트는 **작은 파티클을 무수히 표시**할수록 화려해보이고
	- **연기** 같은 이펙트는 **텍스쳐를 살릴 수 있게끔 크기를 조정**하는 게 좋다.

> Life Sphere Output이라는 컨텍스트도 있다는데, 지금 버전에선 안 보인다. 라이트를 반영할 때 Lit 에서 시작하는 아웃풋 용 컨텍스트라고 한다.


## 구체를 형성하는 이펙트 만들기

### Spawn 설정
- `Constant Spawn Rate 블록` - `Rate : 100000`

### Initialize 설정
- `Capacity : 32768`
- `Set Velocity Random` : A는 -1, -1, -1 / B는 1, 1, 1
- `Set Lifetime Random` : A 값을 2로 설정

#### 블록 추가
- Initialize 컨텍스트 내에서 우클릭으로 Create Block을 클릭, `Position - Position(Circle)(Position)`을 선택.
	- 원형 영역 안의 위치가 파티클의 위치로 설정된다. 
	- `Position Mode`는 `Surface`로 설정되어 있어, 원 둘레 부분의 위치가 설정되도록 되어 있다.
	- `Arc Circle` 항목을 열어 `Radius = 1.5`로 변경.

> 내 경우는 `Shape: Arc Circle` 블럭이 비슷한 역할을 하는 것으로 보임
### Update 설정
- 블록 2개를 생성한다.
	- `Conform to Sphere(Force)`
		- `Radius = 1.5`
		- `Attraction Speed = 25`
		- `Attraction Force = 50`
		- `Stick Distance = 0.2`
			- 파티클의 달라붙는 구체 표면으로부터의 거리
	- `Turbulence(Force)`
		- `Ocatves = 8` (노이드?즈? 옥타브 수)
			- 값이 클수록 자연에 가까운 시뮬레이션이 가능해지지만, 무거운 성능.
		- `Intensity = 10`
			- 난기류의 강도
		- `Drag = 5`
			- 공기의 저항


### Quad Output
- 기본으로 만들어진 블록의 값들을 변경한다.
	- `Blend Mode = Additive`
	- `Main Texture = Default Particle`
- `Size Over Life`
	- 커브 에디터가 나타나는데, 왼쪽 끝(만들어질 때)을 0.01, 오른쪽 끝(사라질 떄)을 0.04로 한다.
- `Set Color Over Life`
	- `Gradient` 필드를 클릭, `HDR`을 흰색 -> 파란색으로 그라데이션 설정
		- 파티클끼리 겹치는 경우 색상이 밝아지므로, HDR에 설정해두면 밝은 부분이 하얗게 날아가지 않고 색감을 표현할 수 있게 된다.
		- `HDR`로 색상을 지정하는 경우, 빛의 강도를 의미하는 `Intensity`도 함께 조정한다.
	- 알파 설정
		- 0% : 255
		- 84.4% : 255
		- 100% : 0
	- 색 설정
		- 0% : 255, 255, 255 / Intensity : 0 
		- 34.4% : 148, 228, 255 / 0
		- 54.1% : 24, 75, 191 / 1.416925
		- 62.4% : 53, 91, 191 / 1.27432
		- 100% : 73, 62, 232 / 0
	- 이 그라데이션은 나중에 사용할 것이기 때문에 `Presets - New` 버튼을 클릭해서 저장해둔다.

여기까지 하면 대충 이런 효과가 나타남. 구체 이펙트라는데 구체인지는 모르겠다. `Turbulence`를 적용했다는 느낌은 확실히 강하게 듦.
![[Pasted image 20241121162542.png]]

> 참고) 셰이더 그래프와는 다르게, `VFX 그래프`는 애셋의 세부설정에서 미리보기할 수 없고, 씬에 띄워야만 미리보기할 수 있다.

## 씬 설정
- 위에서 만든 이펙트 주변을 물고리가 감싸는 형태로, 물 오브젝트를 형상화한 이펙트를 만든다.
- VFX 그래프에서는 여러 이펙트 파일을 조합해 씬에 표시할 수 있다.

### 평면 만들기
- `하이어라키 우클릭 - 3D Object - Plane`
- 이펙트 오브젝트와 겹치지 않게 Position과 Scale을 각각 Y = -4 / Scale은 5로 변경.

### 광원 만들기
- `Directional Light`에서 `Rotation의 X = -30`으로 설정
- 포인트 라이트 : 광원을 추가해서 구체 이펙트 아래에 위치한 평면을 비춘다.
	- `하이어라키 우클릭 - Light - Point Light`
	- `Light - Emission`을 펼쳐서 광원의 색을 의미하는 `Color` = `#769FDD`, 라이트 강도 `Intensity = 150`, 라이트가 닿는 거리 `Range = 25`로 설정.
> HDRP의 경우 Intensity = 4800 lm으로 설정하면 됨. URP와 단위가 다름!

## 새로운 VFX 그래프 에셋 만들기
- 기존 이펙트 주위를 두를 고리 이펙트를 만든다.
### `Spawn` 
- `Rate 10000`으로 설정

### `Lit Sphere Output` 만들기
- `Output` 용 컨텍스트를 만든다. 기존에 있는 `Quad Output` 컨텍스트 제거한 후, `Create Node - Context - Output Particle Lit Sphere` 을 선택해 컨텍스트를 작성 한다.
	- `Smoothness = 1`, `Metallic = 0`으로 설정.
- 컨텍스트 안에 블럭을 2개 추가한다. 
	- `Set Size Over Life`
		- 0.25 위치에서 `0.15`의 크기, 시작점과 끝점은 `0`으로 설정한다. 
	- `Set Color Over Life`
		- 아까 만든 그라데이션과 동일한 그라데이션을 선택함
		- 채도를 떨어뜨려 흰색에 가깝게 만들면 방울 느낌이 난다. 이 그라데이션을 기반으로 옅은 하늘색이 되도록 조정한다.
> `Output Particle Lit Sphere`가 없다. HDRP가 아니기 때문으로, `Mesh Output`을 사용하라고 한다. 근데 내경우는 `Output Particle URP Lit Mesh`가 있어서 이걸 써 봄.
> - 이 경우 설정은
> - `Smoothness : 1, Metalic : 0 , Mesh : Sphere, Blend Mode : Additive`

### `Initialize` 설정
- `Capaicty : 512`
- `Set Position(Attribute Set)` 블럭 추가 
	- 내 경우는 없다. `Set Position`만 추가.
- 노드 만들기 
	- 원형 고리 위를 빙글빙글 돌게 만들어야 함
	- **주기적인 운동을 만들 때는 경과 시간과 삼각 함수를 조합**한다. 
	- 경과 시간 출력 노드 만들기
		- `Create Node - Operator - Time - Total Time(Per-Particle)`
		- 다음으로 경과 시간이 2파이를 곱하기 위해, 파이를 출력하는 노드와 곱셈을 수행하는 노드를 만든다.  삼각함수의 주기가 2파이니까 1초마다 주기를 반복시킨다.
			- `pi` 노드
			- `Multiply` 노드 생성 후, `Total Time` 노드와 `pi` 노드의 `2pi`를 곱셈시킴
		- 블랙보드에서 `float` 속성을 만듦, 이름은 `Ring Radius`
			- `Exposed`을 체크하면 인스펙터에서 값을 설정할 수 있다. `Value`에 초깃값도 설정할 수 있으며, `3`을 지정함.
			- 이를 `Create Node`에서 `Ring Radius`로 검색하면 나옴.
		- `Sine` 노드에 `Multiply` 노드의 출력을 연결
		- 다시 `Multiply` 노드를 추가한다. 
			- `Create Node`를 이용하는 방법도 있지만, 기존 `Multiply`를 우클릭해서 복사 - 붙여넣기 하는 것도 가능하다. 국룰인 단축키도 가능.
		- 이렇게 최종적으로 `Multiply`된 값을 `Initialize - Set Position` 블록의 `Position - X` 필드에 입력한다.
	- 위의 방법대로 하되 Cosine 을 이용한 값을 만들고, 이를 `Set Position - Y`에 입력한다.
![[Pasted image 20241121172334.png]]
![[Pasted image 20241121172246.png]]
그러면 이런 느낌의, 기존 이펙트 주위를 빙글빙글 도는 이펙트까지 구현된 것이다.

> 기존 이펙트가 이상했던 이유가 `Default - Particle`을 써야 되는데 `Particle System`이라는 정체 불명의 텍스쳐를 썼기 때문임.

### Update 설정
- `Turbulence` 블록을 추가, 방울에 움직임을 추가한다. 
	- `Octaves = 5`
	- `Roughness = 0.75`
	- `Intensity = 0.6`
	- `Drag = 5`

## 물보라 고리 만들기
- `Ring` 이펙트를 복제해서 값을 변경하는 작업

### Initialize
- `Capacity = 65536`
	- `URP`에서는 이펙트가 무거워질 수 있기 때문에 16384, 32768 등으로 설정한다.
- `Set Velocity Random`
	- A : `-0.5, 0.33, -0.5`
	- B : `0.5, 1, 0.5`
### Mesh Output
- `Smoothness = 0` : `Size` 커브로 파티클이 더 작아지게 한다.
- 0.25 위치의 키를 제거하고, 0.07 -> 0으로 가는 그래프를 만듦.

### Update
- `Turbulence` 블록
	- `Ocatves = 10`
	- `Roughness = 0.3`
	- `Intensity = 1.65`

### 라이트 배치
- `Light - Spot light` 추가
	- Position : (0, 1, -10)
	- `Light - Shape`의 `Ohter Spot Angle = 120`
	- `Emission` 
		- Color : 8FAD64
		- Intensity : 3000lm (URP는 달라짐)
		- Range : 30
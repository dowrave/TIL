## 260213 : 사운드 정리

>[!done]
>1. 기존 사운드 애셋들 `LUFS` / `peak dB`에 표준화
>	- BGM : -20 LUFS
>	- UI : -9dB
>	- 효과음 : -6dB
>2. `Audio Mixer` 구현 및 기존 스크립트들의 구조 변경
>	- `AudioSource`들을 생성하고 `Audio Mixer`에 세부로 구현한 `AudioMixerGroup`에 연결
>	- 볼륨 조절은 `SoundManager`에서 `Audio Mixer`의 참조를 갖고, 노출된 파라미터로 접근
>	- 0~1로 설정되는 값의 변환 공식 : `dB = -20 * log10(normalizedValue)`

- 3개의 AI에게 물어봄

|  사운드 종류   |  ChatGPT  |  Gemini   |             Claude              |
| :-------: | :-------: | :-------: | :-----------------------------: |
| BGM(LUFS) | -23 ~ -18 | -24 ~ -18 |            -22 ~ -18            |
| BGM(dbFS) |  -3 ~ -1  | -12 ~ -6  | (잔잔) -6 ~ -3  / (일반&전투) -3 ~ -1 |
|  UI 효과음   | -10 ~ -6  |  -6 ~ -3  |            -12 ~ -6             |
|  공격/타격음   |  -6 ~ -3  |  -9 ~ -4  |             -6 ~ -3             |
|    폭발음    |   -3 근처   |  -3 ~ -1  |             -3 ~ -1             |

> - **BGM은 `Integrated LUFS`, 효과음은 `peak dbFS`가 기준**
> 	- LUFS는 평균, `peak dbFS`는 천장 개념이다. 
> - 항상 여유 헤드룸, 즉 `0dB`에 닿지 않도록 소리를 설정해서 내보낼 것.
> - 여기서 폭발음은 보스 스킬 정도만 해당될 것 같다. `Artillery`의 공격은 공격/타격음에 가깝다고 생각함.

위 기준을 참고로 아래처럼 세팅해둠. 소리 종류에 따라 약간의 변동이 있을 순 있겠다.

| 유형     | LUFS | peak dbFS |
| ------ | ---- | --------- |
| BGM    | -20  |           |
| UI 효과음 |      | -9        |
| 공격/타격음 |      | -6        |

> - 사운드 테스트는 헤드셋, 스피커로 진행함

>[!note]
>- **음원을 만들 때는 마스터 볼륨 100%을 기준으로 작업**함. 
>- 만약 인게임에서 소리를 키울 여지를 남겨놓고 싶다면, 단순히 초기 마스터 볼륨 세팅값만 80% 정도로 잡아두면 됨.


>[!note]
>- **유니티 자체에도 `Mixer`가 있음.** `Window > Audio > Audio Mixer`에서 만들고, `BGM, SFX, Master` 등의 그룹을 나눠서 그룹 단위로 볼륨을 조절할 수 있다. 

- 그러면 `AudioSource.volume`의 값을 바꾸던 기존 코드를 `AudioMixer`을 추가하고 여기에 효과음들을 연결하게끔 바꿔야겠다.

### AudioMixer 구성하기
- [[Unity - AudioMixer 세팅]]
- 이제 **모든 소리는 각각이 연결된 믹서로만 관리**된다.
### SoundSettingPopup 수정
- 이제 `AudioSource.volume`을 조절하지 않고 믹서의 볼륨값만 수정하게 됨

- `SoundManager`의 `AudioSource` 관련
	- 성능만 얘기하면 에디터 단계에서 인스펙터에 `AudioSource`를 미리 만들어놓는 게 제일 좋음
	- **근데 관리하기 까다로움.** 대충 20개 가까이 되는 `AudioSource`를 일일이 관리할 수는 없음
	- 그래서 게임이 시작하는 시점에 `AudioSource`를 `AddComponent`로 생성하고 믹서에 할당하는 식으로 구현함

### 소리 크기 관련
- `AudioMixer`는 `dB` 단위로 소리를 체크함.
- 기존의 설정은 `0.0` ~ `1.0`을 오가는 슬라이더였음
- 사람의 귀는 소리 크기를 로그 스케일로 인식하므로, 변하는 볼륨값을 퍼센티지로 해서 그대로 넣으면 소리가 갑자기 확 커지거나 줄어든다고 느낌

- 이 변환에 대해선 **업계 표준이 있음 : `dB = 20 * log10(LinearValue)`**
- 코드로 작성하면
```cs
// 0 ~ 1의 값을 받아 로그 변환
// 최솟값을 설정하는 이유는 -Infinity를 방지하기 위함
float dB = Mathf.Log10(Mathf.Max(0.0001f, sliderValue)) * 20f;
```

### 연결 관련
- 각 `AudioSource`에 어떤 `AudioMixerGroup`을 사용할 것인지는 `[SerializeField]`을 통해 컴포넌트를 할당함
- 근데 **믹서의 볼륨을 조절할 때는 마스터 믹서를 통해서 함**. 
	- 그래서 `Exposed Parameter` 작업이 이뤄졌어야 함

- 그래서 크게 2가지 과정으로 이뤄짐
1. `AudioSource`에 믹서를 등록하는 건 `AudioMixerGroup`을 통해서
2. 볼륨을 조절하는 건 `AudioMixer`를 통해서

> **`AudioMixer`는 애셋 파일 자체를 의미하고**
> **`AudioMixerGroup`은 `AudioMixer` 파일 내부에 있는 세부 요소들을 의미함**
```cs
[Header("Mixer Controller (For Volume)")]
[SerializeField] private AudioMixer masterMixer; // Master, BGM, SFX 등 모든 볼륨 조절을 담당

[Header("Mixer Groups (For AudioSource Routing)")]
// Master Group은 작성하지 않음 - 하위 그룹들에서 연결되기 때문에
[SerializeField] private AudioMixerGroup bgmGroup; // BGM 오디오 소스의 목적지
[SerializeField] private AudioMixerGroup sfxGroup; // SFX 오디오 소스의 목적지
[SerializeField] private AudioMixerGroup uiGroup;  // UI 오디오 소스의 목적지
```

![[Pasted image 20260213224456.png]]
> 가로가 길어서 잘 안 보이는데, 슬라이더를 **100%, 75%, 50%, 25%로 설정함에 따라 각각 0, -3, -6, -12dB 순으로 낮아진다.**

`SFX`와 `UI`를 분리하고 마스터 볼륨도 추가하면서 `SoundSettingPopup` 및 `SoundManager`의 코드와 레이아웃을 수정했음. 끝.


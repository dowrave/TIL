
## 250411

### AWS 블로그
- 오늘 새벽에 마감할 때 `time_value` 테이블이 날아가는 문제가 있어서 그냥 끝낼려고 했는데..
- 다시 컨테이너 들어가보니까 어제 백업 코드를 실행했던 게 잘 들어간 것 같다. ??
- 이런 상태를 유지할 수 있으면 폭파는 보류할 수 있겠음

### githubpage에 작업한 프로젝트 내용 싣기
- 완
- 다시 보니까 `hugo server`에서는 나타나는 이미지들이 실제 환경에서는 나타나지 않음.
	- 이거도 한참을 헤맸는데, **확장자명이 `PNG`인 경우 마크다운에서 참고할 링크를 `.png`로 저장한 경우 못 찾는다.** 와.. 모두 `.PNG`로 수정하면 잘 동작함.

### 블로그에 있는 프로젝트들 다듬기
- 데이터 수집기는 RDS에 이제 데이터가 들어가지 않는 거니까 상관 없음
	- 대신 DB를 살펴봐서, 언제까지 수집되었는지 정도는 명시해둔다
	- 시각화 자체도 DB에서 데이터를 가져오는 거니까 얘를 막을 필요는 없다
- 그림판 추론 기능은 막아야 함
	- 백엔드에 이제 텐서플로우랑 모델이 없기 때문에 사용 불가능
	- 대신 어떻게 썼는지 정도는 넣어두면 좋겠다. 이미지 찍어놓은게 있어서 그거 쓰면 될 듯?
- 블로그의 프로젝트 내용들에도 `Github Page`에서 프로젝트 설명 부분에 링크 걸어둠
- 리액트 다시 빌드해서 버킷에 올리고 클라우드프론트 무효화하고 확인하는 걸로 작업 끝
	- 무효화 직후에 접속했더니 엄청 느려짐ㅋㅋ


## 250410
- 오늘 옵시디언 키니까 왜 폰트가 바뀌어 있지??  -> 아 윈도우 업데이트가 있었다. 폰트는 훨씬 깔끔한 듯.

### 짭명방
- 이거 1도 못함

### 블로그 유지 vs 옮기기
- **최종 결정 : 사이트는 엎는다.**
	- 유지보수에 할애할 시간이 없고, 
	- 비용 절감을 위해 MySQL을 ec2로 옮겼는데 성능적인 문제가 발생하고 있고,
	- RDS에서 백업한 데이터들의 일부가 MySQL에 정상적으로 들어가지 않는다.
- 우선 `github-pages`에 포트폴리오 정리를 해두고, 사이트는 천천히 내리는 걸로 한다.


- AWS 프리 티어가 다음 달에 만료여서 미리 준비해 둠. 
- 어제 깃허브 페이지로 `dowrave.github.io`에 `hugo`로 사이트를 띄워놓기는 했다. 
- 하지만 기존 사이트를 폭파하자니 아쉬움. 
	- 비용이나 사이트 사용 빈도 등을 생각하면 폭파하는 게 더 나아보이지만.. 아까움.
- 비용적인 측면에서 가장 고민인 건 RDS 비용인 듯. 
	- RDS 비용만 줄일 수 있으면 유지하는 것도 괜찮을 듯? 대충 월 2만원 정도임. 
	- 그리고 데이터 수집 프로젝트의 경우는 DB에 유지하는 게 맞을지? 아니면 별도로 빼둘지?

생각할 게 많다..

- 결론 
	1. **RDS에 있는 DB를 EC2 내로 넣을 수 있다면 블로그 폭파 X**
		- EC2에 연결된 볼륨의 크기를 조정할 수 있음. 기존엔 기본으로 할당되는 8GB를 써왔다.
	2. **데이터 수집 자체는 중단**
		- 갑자기 중단되는 경우가 있고, 일일이 모니터링하기도 어려운 상태 
		- 연속적으로 수집된 날짜들에 대해서만 데이터를 올려서 해당 기간들에 대한 조회만 가능하게끔 해보자
	3. 깃허브 페이지도 진행한 프로젝트 설명 정도까지는 작업을 해두자.
		- 마음이 변할 수도 있으니까

- 그러면 사이트를 유지하기 위한 과정은..
1. EC2 볼륨 확장
2. RDS 백업 
3. EC2에 MySQL 넣기 + 기존 프로젝트들 및 EC2의 MySQL 컨테이너 간의 연결 설정

#### 1. EC2 볼륨 확장
- 실행 중인 EC2 인스턴스 중지 -> EBS에 있는 Volume의 설정 변경(30GB) -> 다시 EC2 인스턴스 실행 만으로 쉽게 됐다.
- `putty`로 접속해서 
	- `lsblk` 입력 
		- `xvda(전체 파티션)`이 30gb로 인식됨 
		- `xvda1(루트 파티션)`이 이미 29.9gb로 인식됨(파티션이 디스크 크기에 맞게 자동 확장)
			- 만약 이게 안되면 파티션 할당 작업이 필요한데, AWS에서 자동으로 처리되는 듯. 
	- `df -h` 입력
		- `/dev/root`의 `Size`가 `29G`로 잡힘

#### 2. RDS에 있는 데이터 백업
- 일단 RDS 자체는 20gb로 잡혀 있는데, 접속해서 용량을 확인해보면..
```
+--------------------+---------------+
| 데이터베이스 이름  | 용량 (MB)     |
+--------------------+---------------+
| steam              | 1402.04687500 |
| mysql              |    7.93750000 |
| blog               |    3.09375000 |
| sys                |    0.01562500 |
| information_schema |    0.00000000 |
| performance_schema |    0.00000000 |
+--------------------+---------------+
```
... 생각보다 적다. 

- 일단 MySQL 백업은 완료해서 로컬에 따로 저장해둠

#### 3. 이미지들 설정 변경
- 기존 프로젝트 구조가 `docker-compose.yml`에 한꺼번에 작성은 해놨는데, 실제로는 빌드만 `docker compose build`로 편하게 하려고 그렇게 한 거고 실질적으로는 다 따로 작업하는 방식임
	- 깃을 사용하기에는 텐서플로우가 들어 있어서 프로젝트 사이즈가 좀 큼.
- 그래서 ECR에 빌드한 이미지들을 넣고, 인스턴스에서 해당 이미지들을 꺼내서 사용하는 방식이었다.

- 이 구조를 크게 바꾸지 않고, MySQL에 해당하는 부분만 새롭게 추가함.
	- 백업 내용은 MySQL의 빌드에 있는 Dockerfile에 들어가게 된다.
	- 네트워크, 볼륨 설정은 `docker-compose.yml`에서 하지 않고 인스턴스에서 명령어로 직접 넣는 방식을 취하고 있다.
		- 번거롭다. 근데 대안을 못 찾았음.

- 설정 변경 자체는 간단한 편이다. 
	- **호스트 설정에서 RDS를 엔드포인트로 하던 것들을 `MySQL` 컨테이너의 이름으로 바꿔주기만 하면 됨**
	- 대신 `Dockerfile`이나 `secrets.json` 등에서도 설정되어 있는 값들이 있기 때문에 그런 것들만 수정하면 된다. 이런 건 시행착오로 넘기면 됨.
	- 하지만 1회 테스트가 굉~장히 오래 걸린다는 단점이 있다. 아래는 시행착오 내용
		1) 이미지들을 빌드할 때 적어넣은 환경변수(호스트)명과, EC2에서 호스트명이 일치해야 함
		2) MySQL에서는 접속하는 USER에 DB에 접근할 권한을 부여해야 한다. -> RDS에서 백업했던 `.sql` 파일 아래에 권한을 부여하는 코드를 추가.
		3) 백업한 `.sql` 파일을 넣는 것까지 확인하고 컨테이너에 들어가서 확인했더니 `steam` 데이터베이스만 들어갔고 `blog`는 들어가지 않음
			- 다시 RDS 퍼블릭 연결을 풀고 각 DB에 대한 백업을 따로 실행함
			- 그렇게 넣어도 **`steam`에 대한 데이터베이스만 제대로 들어가고 `blog`는 잘 안들어감**. 원인은 불명임
				- DB를 만드는 코드는 제대로 있고, 실행 순서도 이름 앞에 `01, 02, 03`을 붙여서 명시적으로 지정하려고 했음
			- 그래서 `MySQL` 컨테이너를 띄운 다음 아래 과정을 거침
```sh
# 컨테이너 접속(MySQL이 아니라)
docker exec -it mysql-container bash

# 넣어둔 백업 파일의 내용을 실행시킴
mysql -uroot -p < /docker-entrypoint-initdb.d/01-blog_backup.sql

# 비밀번호 입력
```

> 일단 결론
> - `MySQL`을 여기로 가져오니까, **텐서플로우를 사용해야 하는 코드(프로젝트 2)가 동작하지 않음. 메모리 부족 이슈**로 보임

- 그러면 선택지가 2개가 생기는데
1. 사이트 날리기
2. 텐서플로우 부분만 떼서 빌드하기 (프론트도 수정 필요)
	- 이걸 택함. 아직까지는 사이트를 날리는 건 아쉽다. 
	- `Legacy` 부분으로 분리, `requirements`에 있는 텐서플로우 관련 라이브러리 모두 제거
	- `views.py` 외에도 `urls.py` 부분도 만져야 했다. 
	- 마지막으로 `makemigrations`을 하라는 무서운 이야기까지. 그러면 기존엔 블로그가 어떻게 동작했던 걸까?
		- 로컬에서도 `python manage.py makemigrations`을 했고, 굳이 이미지를 다시 빌드할 필요 없이 컨테이너로 들어가서 `python manage.py makemigrations` 및 `python manage.py migrate`을 실행해서 변경사항을 DB에 적용

- 데이터 수집기도 제거. 수집 기간을 표시하고 갖고 있는 데이터만을 표시한다.

> 오늘 시간을 상당히 많이 뺏겼다. **유지보수가 어려울 것 같으니 일단 엎어야 할 듯.**
> 블로그 내용 자체는 티스토리에 같이 올려둔 게 있어서 괜찮고
> 포트폴리오 부분은 깃허브 페이지에 정리할 예정이고
> 1. 하루 죙일 투자했는데, EC2 인스턴스에 MySQL을 넣으면서 오히려 버벅이는게 훨씬 심해졌다.
> 2. MySQL에서 백업한 내용 중 일부는 소실되는 현상이 있었음(time_value 같은 테이블이 나타나지 않음) 

### Hugo에 프로젝트 정리 중
- 일단 css를 만지고 싶으면 `static/css/custom.css`에서 수정하면 됨
- 벌써 새벽 3시라 일단 끝낸다..


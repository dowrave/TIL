

## 소개

- 유니티에서는 이펙트의 무게에 기여하는 3가지 요소가 있다.

>[!note]
>1. **삼각형 갯수** 
>	- 쉽게 말하면 폴리곤의 갯수
>2. **오버드로우`Overdraw`**
>	- 화면의 픽셀이 한 프레임 내에서 여러 번 그려지는 현상.
>	- 불투명/반투명한 객체
>	- 겹쳐지는 불투명한 객체(멀리 있는게 먼저 그려졌는데 가까운 물체에 의해 가려진다면 앞의 연산은 불필요한 게 됨)
>3. **배치 콜, 드로우 콜**
>	- `드로우 콜`을 묶은 개념이 `배치 콜`임.
>	- `드로우 콜` : CPU가 GPU에게 이 객체를 화면에 그리라고 명령을 내리는 행위. 각 드로우 콜에는 화면에 그릴 객체의 메시 정보, 텍스쳐, 쉐이더, 머티리얼 등이 포함된다.
>	- `드로우 콜`의 증가 원인
>		- 다양한 머티리얼 사용
>		- 다양한 메시 사용
>		- 동적으로 움직이는 오브젝트
>		- 조명과 그림자 효과
>	- `배치 콜`은 여러 오브젝트를 하나의 배치로 묶어서 `GPU`로 보내는 드로우 콜의 숫자 자체를 줄이는 개념이다. 

- **머티리얼도 본질적으로는 쉐이더**이기 떄문에, **1개의 쉐이더로 여러 개의 이펙트를 구현하는 건 성능에 있어서 분명히 좋은 점임.**

>[!question]
> - 강의에선 `Add`와 `AddScroll`을 별도로 구현했다. 이 말대로라면 후자만 구현하고 스크롤 관련 프로퍼티를 모두 0으로 만들어버리는 게 성능상 유리한건 100%다.
> - 하지만 개발 편의성도 고려해야 한다. 
> - **유니티에서는 성능 프로파일링을 지원하므로, 그 기능을 이용하는 걸 추천.** 
> - 사실 저 부분으로 인한 성능 차이가 그렇게 크지는 않을 것이다.

- 예시 1 :  일회성으로 사용되는 `삼각형 갯수Tris`가 1만 개이고 250개의 파티클을 사용하고 배치 콜을 8회 요청하는 오브젝트.
	- 무거운 이펙트지만 **1번만 쓰므로 최적화를 신경 쓸 필요는 없다.** 
	- 턴 기반의 카드 게임 등이 대표적인 예시다. 
- 예시 2 : `Tris`가 500개, 15개의 파티클, 1회의 배치콜이 9번 실행됨
	- **자주 쓰는 이펙트는 경량화가 중요**하다. 

**게임이 실행되는 플랫폼이 가장 중요하다.** 모바일 게임은 PC 대비 최적화가 매우 중요함. 

## Projectile 성능 개선 - 파트 1
- 게임 뷰의 우측 상단에 있는 `Stats`을 보면 `Batches, Tris` 등을 볼 수 있다. 
- 여기선 **`배치 수`** 를 중요하게 볼 거임.
- 지금의 프로젝트에서 투사체 발사 전 / 후를 비교해보면
- 전 
	- `Batches` : 67
	- `Tris` : 4.5k
- 후
	- `Batches` : ~75
	- `Tris` : ~7k

- 즉 지금 구현한 이펙트에서 배치 콜은 최대 8회까지 추가로 발생했다.

### Frame Debugger
- 각 프레임이 어떻게 구성되었는가를 더 자세히 보기 위한 도구.
- `Window - Analysis - Frame Debugger`에 있다. 
- 투사체를 발사하고 `Ctrl + Alt + P`로 화면을 멈출 수 있는데, 이 상태에서 `Frame Debugger`를 활성화`Enable`하면 이것저것 뜬다.
![[Pasted image 20250801152627.png]]
> - 왼쪽의 어떤 항목에 위치했느냐에 따라 게임 뷰에서 렌더링되는 요소가 달라진다. 
> - 화면 읫쪽의 `233`으로 표시된 부분은 현재 선택된 위치.
> - `Levels : 0 ~ 1`로 되어 있는 부분은 밝기를 조절할 수 있는 부분이다. RGBA 각각을 만질 수도 있다. 

- 이 중 `Details`에는 각각의 배치 콜이 왜 발생했는지도 표기된다.
![[Pasted image 20250801152923.png]]
![[Pasted image 20250801152941.png]]

- **배치 콜은 파티클 시스템이 같은 머티리얼을 공유할 때에만 발생**하므로, 모든 텍스쳐를 하나의 텍스쳐에 모아서 1개의 머티리얼만 사용하는 식으로 구현할 수 있다. 

- 그래서 강의에선 무슨 작업을 했느냐
- 포토샵을 킨다 -> 캔버스를 만든다 -> 캔버스를 그리드로 나눈다(8x8) -> 지금까지 작업한 텍스쳐들을 넣고, 사이즈를 줄여서 각 그리드에 넣는다

![[Pasted image 20250801153621.png]]
> - 스프라이트 시트도 각 이미지에 대해 동일한 작업을 거쳤다.
> - **텍스쳐 부분에 빈 공간을 남겨두는 이유는 새로운 텍스쳐를 만들어서 넣을 수 있기 때문**이다. 
> - 강의에서 앞으로 어떤 방식으로 전개할지 모르기 때문에 일단 그대로 따라가봄.

> 프로크리에이트로 작업했다. `2048 x 2048`에 `256 x 256` 이미지들을 넣는 방식. 
![[Texture01_8x8 (2).png]]
> - 작업하면서 느낀 건 "쉽지 않음". 
> - 다른 캔버스의 일부 레이어만 선택해서 드래그 -> 다른 손으로 `갤러리 클릭` -> 텍스쳐 시트 캔버스에 들어가서 레이어 창을 열고 드랍하면 된다.
> - 프로크리에이트로 작업했을 때의 번거로운 점으로는
> 1. 원래 캔버스의 레이어 정보, 예를 들면 `스크린` 같은 설정이 사라진 채로 들어오기 때문에 저기로 옮긴 다음 다시 `스크린`으로 설정해줘야 하는 점. 아예 합친 레이어를 따로 갖고 있다가 복사해도 되긴 하는데, 어차피 배경 레이어 선택은 꼭 해줘야 한다.
> 2. 배경 레이어를 따로 설정하고, 복사할 때 함께 복사해야 한다. 왜냐하면 캔버스 사이즈가 유지된 채로 옮겨져야 하기 때문이다. 텍스쳐 레이어만 복사하면 캔버스 사이즈 `1024 x 1024`가 아닌 깨진 비율이 들어간다.

>[!info]
>- 그래서 텍스쳐 작업을 할 때는 이 방침을 따르는 게 좋겠다.
>1. 배경 레이어는 별도로 구현해놓을 것
>2. 완성된 텍스쳐는 별도의 레이어로 갖고 있으면서도, 동시에 합쳐진 레이어도 하나 갖고 있어야 한다. 




## Projectile 성능 개선 - 파트 2
- 만든 텍스쳐 시트를 유니티로 옮긴다.
- `Beam01` 머티리얼을 복붙해서 `vfx_texture01_Add_8x8`이라는 머티리얼을 만든다. 

### `vfx_hit_v1` 수정

- `Beam`
	- 하이어라키에 올리고 파티클 시스템을 돌려보면 배치 콜이 4회 실행된다.
	- 머티리얼을 위에서 만든 걸로 바꾸고, `Texture Sheet Animation`을 켠다. 
	- 이제 **텍스쳐 시트의 특정 부분만을 가져오는 것으로 수정했기 때문에, `Frame over Time`을 `0`으로 설정**한다. 
		- 값은 0에서 시작함 
![[Pasted image 20250801163358.png]]
> 오른쪽에 선 같은 게 보이는 건 이 `Beam`을 텍스쳐 시트에 넣을 때 배경 레이어를 함께 넣지 않았기 때문에 저 `256 x 256`에 `Beam` 텍스쳐가 가득 찬 것으로 보인다. 초반 작업물이라 인식하지 못하고 지나쳤는데, 그냥 진행하겠음.

- `Particle`
	- `Beam`과 동일하다. 머티리얼 바꾸고, 텍스쳐 시트 켜고, `Tiles` `8 x 8`로 설정하고, `Frame Over Time = 0`

- 머티리얼을 하나 더 만든다. `AddScroll`이 적용된 `vfx_texture01_AddScroll_8x8`.

- `Impact`도 똑같이 작업한다. `Frame Over Time`은 `6`.
	- 근데 이번엔 이펙트가 이상해진다. 
	- 텍스쳐가 `1024 x 1024` -> `256 x 256`이 됐기 때문에, 머티리얼의 프로퍼티 값들도 변경이 필요하다. 
		- `Noise Scale`은 5배 큰 75
		- `Distortion`은 10배 작은 `-0.01`
		- 노이즈 속도도 5~6배 줄인 `0.05`

- `Circle`도 비슷하게 작업.

> 저 경계선이 계속 보이는 이슈가 있음 -,,- 제대로 끊어지지 않은 듯

> 그리고 지금까지 작업했을 때 **머티리얼 양이 3개 -> 2개가 된 건데, 배치 콜 자체는 여전히 4개가 호출되고 있음.**


> 파티클
![[Pasted image 20250801165601.png]]

> 나머지
![[Pasted image 20250801165615.png]]
> 이걸 해결하는 방법이 없다는데? 


- 일단 저런 문제가 없다고 가정하고 강의 내용을 따라감

- 머티리얼을 이제 2개 쓰기 때문에, 배치 콜도 2회 있어야 하지만 가끔씩 3개씩 올라갈 때가 있다. 이는 유니티에서 무엇을 먼저 렌더링할지 모르기 때문에 그렇다.
- 따라서 `Beam, Particles`의 `Sorting Layer`를 2로 잡고, 나머지 `Impact, Circle`을 0으로 잡으면 그 이슈가 사라짐.

### Muzzle 수정

### Projectile 수정
- 강의 내용 따라감. `Alpha Blended`에 해당하는 `8x8` 텍스쳐 시트 머티리얼도 만드는 거임.
- `Alpha Blended`의 `Order in Layer`만 `-2`로 수정
- `Trail`은 텍스쳐 시트 대신 `Trail01_AddScroll` 머티리얼을 유지. `Order in Layer`만 `-3`으로 변경한다. 

- 반영된 내용을 보면 
	- 수정 전) 배치 콜이 38까지 올라감
	- 수정 후) 배치 콜이 36까지 올라감

>[!done]
>- 지금 같은 경우 모션 벡터 관련 문제가 있어서 배치 콜이 감소하지 않았지만, **텍스쳐 / 스프라이트들을 시트로 묶어서 관리하는 개념은 최적화에 있어서 중요한 개념임**
>- 사용되는 이미지의 갯수를 크게 줄일 수 있기 때문이다. 
>- 지금처럼 256 x 256으로 관리해도 괜찮은가 봄?



## Projectile 성능 개선 - 파트 3
- 비슷한 작업을 `Electric` 버전에서도 진행함.
- `Electric` 이펙트들에 대해선 위에서 여러 개의 텍스쳐들을 넣었다.
- `Frame Over Time`에서 해당 이펙트들의 시작점과 끝점을 넣어주면 됨. 
- 내 작업물 기준, 16~21임. 커브에서 최댓값 21 설정하고 시작점을 마우스 커서로 16으로 올리면 된다.
	- 커브의 대략적인 값은 0 ~ 1 사이의 상대적인 값이기 때문에 **휠을 올려서 더 크게 보는 식으로 작업하면 됨.**


- 동일한 머티리얼을 사용하더라도 메쉬가 반영된 파티클은 배치 콜을 유발할 수 있다.
	- 여기선 `ElectricLocal/World` 및 `ElectricCircle`.
		- 후자가 메쉬를 사용함
	- 배치 콜을 하나 줄이려면 **메쉬를 사용하는 파티클의 `Order in Layer`를 파티클 대비 하나 늦추면 된다.**


> 이 부분은 배치 콜이 실제로 안 줄어드니까 ㅋㅋㅋㅋ 학습 의욕을 잃어버림


- 맺는 말
	- 대충 이거저거 많이 만들어보고
	- VFX 포럼에는 월간 챌린지도 있으니 그것도 시도해보라고 한다


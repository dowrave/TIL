
>[!note]
>
>  **"흐름"으로 설명하는 것 외에도 "원리"도 곁들이면 좋다**
> - 지금은 "어떤 이슈가 발생해서 어떻게 해결했더라"로 정리했다면
> - 추가로 **이슈가 '왜' 발생했는지**까지 정리해두면 나중에 볼 때 다시 헷갈리지 않을 수 있음
> 
> 모든 코드를 일일이 기억하는 건 불가능함! 나중에 봤을 때 '이러면 되겠다'는 감이 바로 잡히도록 메모해보자.

>[!objective]
>- 프로젝트가 계속 늘어지는 관계로 완료 기준을 정해놓기로 한다.
>- [[프로젝트 완료 기준에 대해]]
> 	- 소리 추가(BGM 2~3개 + SFX 5개 정도? 링크 참조)
> 	- 이전 스테이지 요소들이 반영된 다음 스테이지 설계 및 밸런스 조절
> 	- 포폴용 프로젝트니까 **진행이 안되지 않는 이상 버그 수정은 자제**
> 	- 치트키 구현 (F1 키 등으로 스테이지 바로 클리어할 수 있게끔)
> - 완료 후에는 프로젝트에 관한 글도 적어두면 좋을 듯
> 	- 무엇을 구현했는지
> 	- 왜 늘어졌는지 등등

> [!issue]
> 간헐적인 이슈들
> - 적이 이미 사라졌는데 계속 해당 위치를 공격하는 현상
> 	- 간헐적으로 발생함

# 251211

>[!done]
>- 기타 이슈 수정
>	1. 마법 대미지가 제대로 반영되지 않는 현상
>		- 수정 완료 : 대미지 타입 불러오는 부분의 이슈
>		- 기타 `enum` 타입으로 정의된 타입들의 `0`번은 다 `None`으로 설정
>		- 버프가 켜졌을 때 공격 타입이 물리로 바뀌는 현상도 있었음 : 수정 완료.
>	2. `DualBlade`의 2번째 스킬에서 VFX를 찾지 못하는 문제 수정
>		- `PreloadObjectPools` 메서드에서 상속이 제대로 되지 않던 이슈 수정
## 스테이지 조정 : 1-2
- 지금 전체적으로 답답해지는 부분은 `Enemy_Tanker` 때문인 것 같음
- `Caster`나 `DualBlade`의 마법 공격으로 공략하라는 기믹이긴 한데 정작 `Tanker`에게 대미지가 들어갔을 때 별로 티가 안 남

### 마법 대미지가 제대로 반영되지 않는 현상
`UnitEntity.TakeDamage`에서 아래 로그를 찍어봤다.
```cs
if (source.Type == AttackType.Magical)
{
	Logger.Log($"들어간 마법 대미지 : {remainingDamage}");
}
```

근데 로그가 안 나타남. 
#### 구조 수정
- **`_currentAttackType`에 반영이 안 되어 있고, `enum AttackType`의 디폴트값이 `Physical`이기 떄문에 발생하는 문제** 였던 것으로 보임
	- 구조상 **`enum` 타입의 0번에 두는 값은 사용하지 않는 값**으로 두는 게 좋아보인다. 

> 근데 `enum` 한 번 고치니까 기존에 짜놨던 거 다 꼬였다. 배운 값이 좀 비싸네..

#### 스킬 켜졌을 때 다시 물리 대미지로 돌아가는 현상 발생
- 이거도 위에서 `AttackType` 관련 설정 때문에 발생하는 현상임
- `AttackType`의 0번을 `None`으로 뒀고, 설정이 없을 때는 `Operator`에 설정된 `AttackType`을 따라가도록 구현함

## 기타 이슈
### `DualBlade` 2번째 스킬 - VFX 못 찾는 문제
- `PreloadObjectPools(OperatorData opData)`의 상속 방식이 이상했음. 
- `OperatorSkill -> ActiveSkill -> ...`으로 이어져야 하는데 부모에서 정의해 놓은 걸 자식에서 이용하지 않는다든지 하는 이슈 등이 있었다.
```cs
// OperatorSkill.cs
public virtual void PreloadObjectPools(OperatorData ownerData)
{
	// 근접 공격 VFX 변경
	if (meleeAttackVFXOverride != null)
	{
		ObjectPoolManager.Instance.CreatePool(GetMeleeAttackVFXTag(ownerData), meleeAttackVFXOverride, 2);
		Logger.Log($"{name}의 풀 : {GetMeleeAttackVFXTag(ownerData)} 등록 완료");
	}
}

// 자식 : ActiveSkill.cs
public override void PreloadObjectPools(OperatorData opData)
{
	base.PreloadObjectPools(opData);

	if (durationVFXPrefab != null)
	{
		ObjectPoolManager.Instance.CreatePool(GetDurationVFXTag(opData), durationVFXPrefab, 1);
	}
}

// 실사용 : Operator.PlayMeleeAttackEffect
protected virtual void PlayMeleeAttackEffect(Vector3 targetPosition, AttackSource attackSource)
{

	string effectTag = _operatorData.GetMeleeAttackVFXTag();

	var vfxBuff = activeBuffs.FirstOrDefault(b => b.MeleeAttackVFXOverride != null);
	if (vfxBuff != null)
	{
		effectTag = vfxBuff.SourceSkill.GetMeleeAttackVFXTag(_operatorData);
	}
        
        if (!string.IsNullOrEmpty(effectTag))
        {
	        // 이제 스킬 스크립트에서 풀을 생성하므로 이것도 정상적으로 동작함
            GameObject? effectObj = ObjectPoolManager.Instance!.SpawnFromPool(
                   effectTag,
                   transform.position,
                   Quaternion.identity
           );
```




# 251210

>[!done]
>1. 고장난 Slider 기반 컴포넌트 고치기
>2. 충돌로 인한 살짝의 위치 변화 구현

> [!wip]
> - 스테이지 조정
> 	- `1-2` 진행 중

## 고장난 Slider 기반 컴포넌트들 고치기
- 현재 발생 중인 이슈
	- `SPBar`의 로그를 찍어보면 상태값은 정상적으로 추적되는 상태인데 유니티의 이미지 갱신이 되지 않음

- 수정 완료
	- 이전에 `square_sprite`를 지우면서 기존 `Source Image`들의 `Texture`가 `None`이 됐는데 그거 관련 이슈로 보인다
		- 근데 `HealthBar`는 없이도 잘 작동하는데 얘는 왜 그러는지 모르겠다.
	- `SPBar`는 `Slider` 기반으로 동작하도록 수정, `AmmoMode` 활성화 시 `Slider`는 비활성화

- 비슷한 이슈가 코스트 회복 게이지에서도 발생, 수정 완료

## 스테이지 밸런스 조정


## Enemy 완전히 겹칠 경우 살짝 이동하도록 수정
- 겹칠 때 `UI`가 보이지 않아서 헷갈린다. 아군이 적을 치더라도 누굴 치는지 헷갈리는 상황이 있음

> 원본은 배치될 때 적 유닛을 살짝 밀어내는 로직이 들어가 있을 거다
> 	- 이걸 이용한 테크닉으로 두 타일에 걸치게 만들어서 양쪽에서 동시에 타격 가능하게 하는 방법도 있음

- 원래는 UI만 살짝 이동시키려고 했는데, 하는 김에 제대로 구현해보자.

일단 무지성으로 제미나이에게 질문하고 받은 스크립트에서 시작함. [[짭일방주 - 겹쳤을 때 이동 구현]]

```cs
hitCount = Physics.OverlapSphereNonAlloc(transform.position, bodyRadius * 2, hitColliders, unitLayer);
```
위 스크립트를 이용해서  레이어 기반으로 콜라이더 판정을 이용해서 밀어내는 기능만 있는 상태다.


![[MovementEarthQuake.gif]]
>ㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋ 지진났네

### 떨리는 현상 발생 및 수정

- 개요
스크립트 이름은 `UnitOverlapSolver`이며, `Enemy, Operator`의 가장 부모 스크립트 위치와 동일한 오브젝트의 컴포넌트로 위치해 있다. 이 스크립트가 동작하는 조건은 `Overlap`을 쳤을 때 범위 내에 동일한 스크립트가 있는 것.

- 문제 상황
**등장부터 신나게 흔들린다. 다른 오브젝트가 없어도 흔들림.**

- 아래처럼 로그를 찍어봄
```cs
for (int i = 0; i < hitCount; i++)
{
	Collider other = hitColliders[i];

	if (other.gameObject == gameObject) continue;

	// 유닛 콜라이더는 자식 오브젝트로 둠 -> 부모에서 이 스크립트를 찾아야 함
	UnitOverlapSolver otherUnit = other.GetComponentInParent<UnitOverlapSolver>();

	if (otherUnit != null)
	{
		Logger.Log($"다른 오브젝트 {otherUnit.gameObject.name}를 찾아서 충돌 로직 계산 시작");
		
		// ...
```

> 여기서 `otherUnit.gameObject.name`이 자기 자신의 오브젝트가 나타나고 있음 
> - 콜라이더의 위치는 자식 오브젝트라서 위의 `continue` 조건문이 제대로 동작하지 않음. 
> - 왜냐하면 `other.gameObject`는 콜라이더가 위치한 자식 오브젝트인데 `gameObject`는 이 스크립트가 위치한 부모 오브젝트이기 때문임
> - 따라서 `if`문을 아래로 이동시키고, `otherUnit.gameObject == gameObject` 조건으로 수정해주면 된다. 고 생각해서 수정

```cs
	UnitOverlapSolver otherUnit = other.GetComponentInParent<UnitOverlapSolver>();
	
	// 위치 이동 및 조건 수정
	if (otherUnit.gameObject == gameObject) continue;
```

> 일단 이거는 의도한 대로 잘 동작한다. 계속 테스트 ㄱㄱ
### 계속 테스트

- `Enemy` 1개가 저지 당하는 중에 다른 `Enemy`가 비슷한 위치로 진입할 때 고정된 `Enemy`가 스윽 밀려버리는 현상이 있음
	- 반지름을 줄이면 되지 않을까? `0.2` 정도인데 `0.05`로 수정해봄
	- **이거 갖고는 부족한 듯**

- `Deployable`, `Enemy` 관련 조건들을 추가함
	- `Deployable`는 배치된 후에만 동작함.
	- `Enemy`의 경우는 이 스크립트를 갖고 있는 자신과 상대가 모두 저지 당하는 중일 때에만 동작함.
```cs
    // 충돌한 상대가 Deployable일때 조건 체크
    private bool CheckConditionAboutDeployable(UnitOverlapSolver otherUnit)
    {
        DeployableUnitEntity otherDeployable = otherUnit.GetComponent<DeployableUnitEntity>();
        if (otherDeployable != null && otherDeployable.IsPreviewMode) return true; // 미리보기 중에는 이 스크립트로 인한 처리 진행 X
        return false;
    }

    // Enemy의 경우, 저지당할 때만 동작함
    // 이동 중에도 동작하게끔 구현하면 멈춰있는 오브젝트 A의 위치로 이동하는 오브젝트 B가 진입할 때 B가 A를 밀어넣어버리는 현상이 발생함
    private bool CheckConditionAboutEnemy(UnitOverlapSolver otherUnit)
    {
        Enemy thisEnemy = GetComponent<Enemy>();
        Enemy otherEnemy = otherUnit.GetComponent<Enemy>();
        
        // 스크립트의 동작 조건 : 두 Enemy가 모두 저지당한 상태에서만 동작
        if (thisEnemy != null && 
            otherEnemy != null && 
            thisEnemy.BlockingOperator != null && 
            otherEnemy.BlockingOperator != null)
        {
            return true; 
        }

        return false;
    }
```

이 스크립트들을 아래처럼 넣어줌

```cs
	if (otherUnit != null)
	{
		// 상대가 배치 요소인데 미리보기 모드일 때는 처리하지 않음
		if (CheckConditionAboutDeployable(otherUnit)) continue;
		if (CheckConditionAboutEnemy(otherUnit)) continue;
		
		Logger.Log($"다른 오브젝트 {otherUnit.gameObject.name}를 찾아서 충돌 로직 계산 시작");

		// ...
	}
```

하드코딩이라 마음에 들진 않는데 일단 원하는 대로 구현은 되고 있으니 냅둔다. 밀어넣는 현상이 발생하지 않는 건 아닌데 납득할 수 있는 수준으로 움직임.
# 251209

>[!done]
>1. 프로젝트 유니티 버전 업데이트 : `6000.0.41f1` -> `6000.3.0f1(LTS)`
>2. 1. 에 의해 이미지 깨지는 현상들 수정
>
## 버전 업데이트에 따른 이슈들
### UI 이미지나 스프라이트가 깨짐
1. 스테이지 선택 패널 - 사이드 패널
	- 패널 자체의 텍스쳐에서 문제가 발생한 것으로 보임(근데 기가 막히게 버튼 주위만 검은 박스가 나타남)
	- 해당 텍스쳐를 제거하고 새로운 텍스쳐를 만들어 넣음
![[TransparentToWhite.png]]
> 1. 30% 지점에서 알파 255를 가짐
> 2. 기존엔 텍스쳐 자체가 검정색이었는데 색은 유니티에서 바꾸면 되니까 흰색으로 구현
> 3. 기존 패널 너비 600은 경계선 부분이 하얗게 뜨는 현상이 발생했음(`Repeat`가 아님에도)
> 	- 너비를 넓혀주니까 경계선이 사라짐

2. "현재 선택 중인 스킬 버튼" 이미지 관련
	- 방향이 이상하게 돌아갔는데 원래대로 돌아왔다. ??

3. 결과 패널 관련
	- 옛날에 `None`으로 둬도 되는 부분을 흰 단색 이미지인 `square_sprite`로 채워넣은 부분이 있었는데, 해당 부분이 차지하는 영역의 가장자리가 부드럽게 처리되면서 발생한 이슈로 보임
	- `square_sprite` 이미지를 삭제했음

### 오퍼레이터 SP 게이지 상태 반영 안되는 문제
- `SPBar`에 한정한 이슈 - `HealthBar`는 체력 변화가 잘 나타남;
	- 배치하자마자 SP가 만땅인 상태를 유지함
	- 실제 상태가 고정되는 이슈는 아니다. 오퍼레이터 클릭 시 보이는 SP값은 변화되고 있음
	- 스크립트를 추적해봐도 값 자체는 잘 나타남
- 이거 해결 못했음


# 251208
- 간헐적인 이슈 - 적이 이미 사라졌는데 계속 해당 위치를 공격하는 현상
	- 왜 발생하는지 모르겠음. 적이 죽으면 계속 해당 위치를 때리는 것도 아닌데 가끔 저 이슈가 발생함. 
	- 아마 살아있다고 인식하는 것 같은데 죽는 시점(비활성화)에 이벤트를 발생시키고 있는데..



# 251204

>[!done]
>- 플레이 테스트 및 밸런스 조정
>	- 코스트 회복 속도 관련

## 플레이 테스트 및 밸런스 조정
### 코스트 회복 속도 관련

전반적으로 게임이 무겁게 느껴진다. 돌발 상황이 생겼을 때 그거에 대응할 자원이 없는 경우가 많다. 지금까지는 코스트가 없는 경우가 많음(오퍼레이터를 배치할 수 있음에도)

여기에 영향을 주는 요소가 크게 아래와 같은데,
- 적의 이동 속도
- 배치 코스트 자연 회복 속도
- 초기 코스트

이 수치들을 만져가면서 적합한 지점을 찾아봐야겠음

- 적 이동속도 : 약 70%로 설정
- 투사체 속도 : 5 -> 3
		- (모든 투사체 속도가 동일했다)

이동속도 낮춘 게 많이 괜찮아 보인다. 


> 일단 지금 포커스를 두고 있는 건 '**뱅가드 육성 없이 게임을 깰 수 있는가?**'이다.



## 기타 이슈 수정

### 스테이지 클리어 로직 중
- 3성 이하로 클리어한 스테이지를 다시 깼는데 기존보다 수치가 같거나 낮을 때에 대한 처리가 작성되어 있지 않았음
```cs
	// 기존 기록보다 더 잘 클리어했을 때
	if (resultInfo.stars < stars)
	{
		if (resultInfo.stars == 1)
		{
			if (stars == 2) return 0.25f;
			if (stars == 3) return 0.75f;
		}
		else if (resultInfo.stars == 2)
		{
			if (stars == 3) return 0.5f;
		}
	}
	// 추가
	else 
	{
		// 기존 기록과 같거나 더 못 깼을때
		return 0f;
	}

	throw new InvalidOperationException("FirstClearItemRate의 예상치 못한 동작");
```
> `stars`가 이번에 클리어한 스테이지의 기록, `resultInfo.stars`가 기존 기록이라고 할 때, 여기까지만 작성하면 "기존 기록보다 더 못 깼을 때"에 오류가 발생함
> 단순하게 `else` 문에 `return 0f`만 달아주면 해결되는 이슈였다. 최초 클리어 보상에 관한 메서드이기 떄문.

### AreaHasteHeal 스킬에서 힐이 안 나감
- `AreaHasteHealController`에는 `Initialize`가 없었다. 상위 클래스를 보면 
```cs
public virtual void Initialize(
	UnitEntity caster,
	IReadOnlyCollection<Vector2Int> skillRangeGridPositions,
	float fieldDuration,
	float tickDamageRatio,
	float interval,
	GameObject hitEffectPrefab,
	string hitEffectTag
	)
{
	this.caster = caster;
	this.skillRangeGridPositions = skillRangeGridPositions;
	this.fieldDuration = fieldDuration;
	this.interval = interval;
	this.tickDamageRatio = tickDamageRatio;
	this.hitEffectPrefab = hitEffectPrefab;
	this.hitEffectTag = hitEffectTag;
	
	// 이 아래 부분 추가
	if (_currentCoroutine != null)
	{
		StopCoroutine(_currentCoroutine);
		_currentCoroutine = null;
	}

	_currentCoroutine = StartCoroutine(FieldRoutine(fieldDuration, interval));
}
```
이런 구조인데, 기존엔 필드 설정하는 부분만 있었고 아래의 if문 부터는 방금 추가한 부분이다.

> - **그래서 기존에 어떻게 동작한 건지가 더 궁금하다.** 이거 없으면 틱으로 들어가는 동작이 아예 작동을 안 할텐데?
> - `ArcaneField`의 경우는 별도의 `Initialize`를 사용해서 상관 없는 이슈

#### 조금 더 개선해봄
- 부모 클래스의 `Initialize`에서 코루틴까지 한꺼번에 실행시키는 대신, `Initialize`는 구현해놓되 세부 내용은 자식 클래스에서 다시 설정하도록 하면 됨
- 대신 필드를 할당하는 메서드, 코루틴을 실행하는 메서드를 따로따로 만들고 `Initialize`에서 해당 메서드들을 실행시키는 방식
- 필드가 늘어지는 건 지금 수정하기 귀찮으니까 냅둠(..)


# 251203

>[!done]
>
>- 플레이 테스트 및 밸런스 조정
>- 기타 이슈 수정
>	- `Enemy`에 누락된 `ID, Localization Key` 등등 추가
>	- 범위 이펙트 관련 이슈 수정(텍스쳐 누락, 조건문 등등)
>	- `Artillery`의 타격 이펙트 오브젝트가 풀로 돌아가지 않는 현상 수정

## 플레이 테스트와 밸런스 조정


## 기타 이슈 수정

- `Entity`에 누락되었던 `ID, Localization Key` 값 설정

### AreaHasteHealSkill - 범위 이펙트 나타나지 않음
- 크게 2가지 문제가 있었다.
1. 텍스쳐가 사라졌음.
2. 이펙트의 경우 셰이더로만 구현한 것도 있고, 파티클 시스템으로 구현한 것도 있음 
	- 벽 이펙트가 안 나타나는 현상도 수정 완료

### Artillery - Hit VFX
1. 범위 공격에 맞은 적들 모두에게 피격 이펙트가 나타나는데 부자연스러워 보임
	- 폭발 지점은 1개여야 하는데 피격된 객체 수만큼 이펙트가 나타남
	-  `Projectile`에 붙어 있는 `CreateAreaOfDamage` 메서드를 실행할 때, 이펙트를 여기서 1회만 실행시키는 방식으로 구현했다.
		- 원래는 `UnitEntity.TakeDamage` 안에 `PlayGetHitVFX()`가 있다. 피격 로직 안에 피격 이펙트 실행 로직을 붙여놨는데, 위에서 수정한 로직과 겹치기 떄문에 `TakeDamage`에는 피격 이펙트를 실행할 지 여부를 판단하는 `bool` 파라미터를 추가해뒀다.

> 여기도 교통 정리가 필요해보이긴 하는데, **일단 게임을 완성한 다음에 시간이 있을 때 수정**하기로 하겠음. 앞으로도 부족한 부분은 계속 보일 건데, 이거 일일이 수정하다 보면 너무 시간을 많이 쓰게 된다.

2. 오브젝트 풀링 문제 
- 이펙트의 재생 시간을 초과했는데도 풀로 돌아가지 않고, 새로운 오브젝트가 풀에 계속 생성됨.
	- 이거 좀 재밌는 부분인 게 **1번을 수정하니까 2번도 고쳐졌다.**
	- 이전 코루틴 실행을 멈추는 로직도 추가했지만,
	- 처음에 생각한 오브젝트 풀에 있는 오브젝트 갯수를 초과해서 **한꺼번에 여러 개가 생겨서 실행되어서 그런 걸까? 정확한 원인은 모르겠음.**

# 251201

>[!done]
>- 스테이지 밸런스 수정
>	- `Tanker` 방어력 550 -> 400 -> 350으로 하향
>	- 스테이지 1-1 몹 생성 타이밍 수정
>	- 스테이지 1-2 맵 크기 축소 
>		- 밸런스는 더 만져야 할 듯
>- 기타 이슈 수정
>	- 바리케이드 이름 한글로 나타나지 않는 현상 수정

## 스테이지 밸런스 수정

### 1-1
- 탱커 방어력 500에서 350으로 하향
- 탱커 생성 시간 간격 조정

### 1-2 
- 맵 크기 축소(비슷한 구조의 맵을 새로 만듦)
- `Default` 몹들 전반적으로 하향해야 할 듯? `Ghost`도 이속이나 체력 깎아야 할 것 같다.





## 기타 이슈 수정
### 바리케이드 이름 한글로 나타나지 않는 현상
```cs
private void UpdateDeployableInfo()
{
	HideOperatorPanels();
	// nameText.text = currentDeployableInfo.deployableUnitData?.EntityID ?? string.Empty;
	nameText.text = GameManagement.Instance!.LocalizationManager.GetText(currentDeployableInfo.deployableUnitData?.EntityNameLocalizationKey) ?? string.Empty;
}
```

### `RetreatButton` 입력 시 천천히 사라지는 현상
- 바리케이드에서 보였던 이슈다. 퇴각 버튼은 바로 사라지게끔 구현해야 할 듯
- 버튼을 입력했을 때 `deployable.Retreat()`이 있는데 막상 `deployableUnitEntity.Retreat()`의 디버깅 로그는 관찰이 안 됨.

- 아 **`Barricade`에 `Retreat` 메서드가 따로 있었다. ㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋ**
```cs
public override void Retreat()
{
	UndeployBarricade();
	base.Retreat();
}

protected override void Die()
{
	UndeployBarricade();
	base.Die();
}

private void UndeployBarricade()
{
	CurrentTile!.ToggleWalkable(true); // 현재 타일 이동 가능으로 변경
	PathfindingManager.Instance!.RemoveBarricade(this); // 바리케이드 리스트에서 제거
	OnBarricadeRemoved?.Invoke(this); // 제거 이벤트 발생
}
```

바리케이드에는 경로 관련 요소가 있기 때문에 이걸 별도의 메서드로 구분하고 그 외에는 `DeployableUnitEntity`의 로직이 동작하도록 수정했음.


- `Guard - SlashSkill` 버튼 입력시 오류 발생
	- 스킬 태그를 못 찾는다고 함
```cs
            GameObject effectObj = ObjectPoolManager.Instance.SpawnFromPool(GetSlashControllerTag(caster.OperatorData), caster.transform.position, caster.transform.rotation);
```
> `SO`자체가 `string skillTag`로 갖고 있는 구현이 안 좋아서 이전에 수정했는데, 이 부분은 메서드를 만들어놓고 그냥 지나간 듯.

## 발견했으나 간헐적이라 수정하지 않음
- `Guard`가 저지하는 적이 없는데도 적이 `Guard`에 의해 저지되지 않고 그냥 진행하는 현상





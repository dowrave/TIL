
# 251106 - 짭명방
>[!done]
>- 발견한 이슈
>	- `Sniper` 강타 스킬 터질 때 나타나는 텍스트가 겹침
>	- `DualBlade` 스킬 이펙트(보라색 슬래시 이펙트)가 나타나지 않음
>	- `OperatorSkill`의 VFX 오브젝트들 태그 관리 방법 수정
>	- 오퍼레이터의 스킬을 사용할 때 여기서 `Instantiate`로 실행되는 요소들이 있음
>		- 이것들도 태그 이름을 `Stateless`으로 관리하는 오브젝트 풀링 기반으로 변경
>	- 게임 시작 시 스테이지 배속된 상태로 시작하는 현상 수정
>	- 메인 메뉴 패널 전환 시 부드럽지 않은 느낌 수정

## 이슈 수정

### Sniper 강타 스킬 터질 때의 텍스트 겹치는 현상
![[Pasted image 20251106154111.png]]
> 여기서 뜬 대미지는 488임

그럼 저 앞의 폰트들은 뭐지? 오브젝트 풀 로그를 추적해봄

- `Projectile.HandleHit`에서 자체적으로 띄우고 있었다.
	-> 지금은 **`TakeDamage`에서 대미지 계산 완료 후 해당 텍스트를 보여주는지 여부까지 체크해서 거기서 나타나도록 구현되고 있다. 그래서 여기서 별도로 처리할 필요는 없음.** 그래서 제거.

### DualBlade 스킬 이펙트가 나타나지 않는 현상
> `Operator.PlayMeleeEffect` 
```cs
// [버프 이펙트 적용] 물리 공격 이펙트가 바뀌어야 한다면 바뀐 걸 적용함
// 이 코드의 전제 조건은 "근접 공격 이펙트를 쓰는 다른 버프가 없다"이다. 상황이 바뀌면 코드를 바꿔야 함.
var vfxBuff = activeBuffs.FirstOrDefault(b => b.MeleeAttackEffectOverride != null);
if (vfxBuff != null)
{
	// effectPrefab = vfxBuff.MeleeAttackEffectOverride;
	effectTag = vfxBuff.SourceSkill.GetVFXPoolTag(this, vfxBuff.SourceSkill.meleeAttackEffectOverride);
	Debug.Log($"버프로 인한 물리공격 이펙트 변경 : {effectTag}");
}
```
> 여기서 `vfxBuff`를 가져오는 부분에 `null` 체크가 없어서 추가해봄
 -> 이렇게 해도 안 됨

- 로깅을 해보면 `effectTag`를 가져오지 못하고 있음
- `OperatorSkill`의 근접 공격 관련 로직들을 보면 이전에 `Stateless` 기반으로 구현했던 것들이 들어가 있지 않다. 여기에도 추가해줬음.
```cs
public virtual void PreloadObjectPools(OperatorData ownerData)
{
	// 근접 공격 VFX 변경
	if (meleeAttackVFXOverride != null)
	{
		// MELEE_ATTACK_OVERRIDE_TAG = RegisterPool(ownerData, meleeAttackEffectOverride);
		ObjectPoolManager.Instance.CreatePool(GetMeleeAttackVFXTag(ownerData), meleeAttackVFXOverride, 2);
	}
}

public string GetMeleeAttackVFXTag(OperatorData ownerData) => $"{ownerData.entityName}_{skillName}_MeleeVFX";


```

- 수정 완료
![[Pasted image 20251106164739.png]]

### 일부 오퍼레이터 스킬 Stateless로 관리되지 않고 있었음
- 위 이슈를 수정하면서 알게 된 건데 일부 스킬이 오브젝트 풀링을 이상하게 쓰고 있었음
- 수정 완료
```cs
public string GetSkillControllerTag(OperatorData ownerData) => $"{ownerData}_{skillName}_SkillController";
public string GetSkillRangeVFXTag(OperatorData ownerData) => $"{ownerData}_{skillName}_SkillRangeVFX";
public string GetHitVFXTag(OperatorData ownerData) => $"{ownerData}_{skillName}_HitVFX";

// 스킬 관련 오브젝트 풀 초기화.
public override void PreloadObjectPools(OperatorData ownerData)
{
	base.PreloadObjectPools(ownerData);

	if (skillControllerPrefab != null)
	{
		ObjectPoolManager.Instance.CreatePool(GetSkillControllerTag(ownerData), skillControllerPrefab, 1);
		// FIELD_EFFECT_TAG = RegisterPool(ownerData, fieldEffectPrefab, 2);
	}
	if (skillRangeVFXPrefab != null)
	{
		ObjectPoolManager.Instance.CreatePool(GetSkillRangeVFXTag(ownerData), skillRangeVFXPrefab, skillRangeOffset.Count);
		// SKILL_RANGE_VFX_TAG = RegisterPool(ownerData, skillRangeVFXPrefab, skillRangeOffset.Count);
	}
	if (hitVFXPrefab != null)
	{
		ObjectPoolManager.Instance.CreatePool(GetHitVFXTag(ownerData), hitVFXPrefab, 10);
		// HIT_EFFECT_TAG = RegisterPool(ownerData, hitEffectPrefab, 10);
	}
}
```
> 이 `PreloadObjectPools`은 스테이지가 시작되기 전에 한꺼번에 생성됨

- `OperatorSkill`의 기존 요소들은 제거

> 일단 보이는 것들을 수정 완료했음. 추가로 보이면 더 처리함.
### 스테이지 배속된 상태로 시작하는 현상 수정
- 현상) 스테이지 시작 후 아무 클릭도 하지 않았을 때 2배속으로 게임이 진행됨
	- 클릭만 해도 1배속으로 돌아오긴 함. ??
- 이전에 `Time.timeScale`로 다 다시 수정하는 과정에서 그 값이 `2f`로 설정되어 있었다. `1f`로 복구.

### VFX 일부 효과 마젠타 색으로 나타남
- 이전에 머티리얼을 정리하는 과정에서 일부 VFX들을 제대로 처리하지 못한 듯
- 수정한 요소들
	- `VFX_Hit_Lightning_v1`
	- `Boundary_Caster2ndSkill`

### 패널 페이드인되기 전에 내부 요소들 초기화
- 지금은 페이드인되면서 초기화가 진행되므로 초기화되기 전의 요소들이 보이는 게 어색함
	- 페이드인되면서 **초기화 전 -> 초기화 후로 바뀌는 게 순간적이지만 보여서** 장면 전환이 깔끔하지 않다고 생각함

- 처음에는 `OnEnable`되는 과정에서 UI들이 초기화되기 떄문이라고 생각했는데, 일시정지를 (드디어) `Space` 키로 지정한 다음에 전환 과정을 프레임 단위로 지켜본 결과 `CanvasGroup`이 투명한 상태에서 UI들이 의도한 것과 다르게 보이는 현상이 있음
	- 예를 들면 어떤 `Image`는 흰색이 전혀 없음에도, 알파값이 낮을 때는 흰색이 보이다가 진해지면서 사라지는 것이 보임

- 따라서 이건 초기화 이슈라기보다는 **패널의 알파값이 낮을 때 일어나는 이슈**에 가까운 듯
- 그러면 페이드 인을 알파값이 완전히 0인 상태에서 진행하는 게 아니라 조금 더 높인 상태에서 진행하면 어떨까?
	- 이렇게 접근해봤는데 큰 차이는 없는 듯..

- 전체적인 패널 색을 조금 더 어둡게 통일해봤음
- `OperatorSlot.SkillImage` 부분이 밝았다가 자기 이미지로 변하는 현상이 있음 -> 이 부분이 좀 어색해보이긴 함
	- 저 "밝았다"는 지점이, **`SkillIconBackground`가 있는데 흰색으로 되어 있음. 이걸 검정색으로 바꿔봄.**

1.  **`Background`로 설정된 요소들이 다 흰색이어서, 알파값이 변하는 과정에서 그 부분이 변하는 게 더 두드러져보임**
2. 근데 꼭 1번만으로 다 설명할 수 있는 건 아님 - 근데 일단은 여기까지 

일단 이 정도로 괜찮은 듯 해서 넘김 - 모두 해결한 건 아닌데 너무 많은 시간을 쓰는 것도 아닌 듯 해서.

# 251105 - 짭명방

>[!done]
>- `LoadingScreen` : 로비로 돌아갈 때 페이드아웃되지 않는 현상
>	- 스테이지 종료 시점에 `Time.timeScale = 0f`가 되면서 발생한 현상.
>	- 씬 전환 과정은 시간이 정상적으로 흘러가야 하므로 `LoadScene`의 시작 부분에 `Time.timeScale(1f)`을 달아준다.
>		- `DOTween`의 시퀀스에 `.SetUpdate(true)`을 달아줘도 해결 가능
>- `GameManagement.TimeManager` 제거
>	- `Time` 클래스로 다 처리 가능함
>- `StageSelectPanel`에서 `StageDetailPanel`을 띄울 때의 애니메이션 구현
## LoadingScreen - 로비로 돌아갈 때 페이드아웃되지 않는 현상

- 코드
```cs
    // 검은 화면만 사용할 경우
    public void Initialize()
    {
        ResetState();

        gameObject.SetActive(true);
        stageInfoPanel.gameObject.SetActive(false); // 정보 패널 부분은 비활성화

        Debug.Log("[LoadingScreen]어두운 화면만 나타나는 Initialize");

        // 어두운 패널이 서서히 나타남 - Append 개념은 순차적으로 동작함
        currentSequence = DOTween.Sequence();
        currentSequence.Append(screenFader.DOFade(1f, fadeOutDuration))
            .OnComplete(() =>
            {
                OnFadeInCompleted?.Invoke(); // 이 패널이 완전히 나타난 후 이벤트 발생
            });

        currentSequence.Play();
    }
    
    // 스테이지 진입 시 사용 - 스테이지 이름과 로딩 게이지를 함께 보여줌
    // 로딩 화면을 띄우고 스테이지 매니저의 로딩 완료를 기다림
    public void Initialize(string stageId, string stageName)
    {
        ResetState();

        gameObject.SetActive(true);

        // 스테이지 정보 및 로딩 게이지 활성화 
        stageIdText.text = stageId;
        stageNameText.text = stageName;
        loadingSlider.gameObject.SetActive(true);

        // 어두운 패널이 서서히 나타남 - Append 개념은 순차적으로 동작함
        currentSequence = DOTween.Sequence();
        currentSequence.Append(screenFader.DOFade(1f, fadeOutDuration))
            .OnComplete(() =>
            {
                Debug.Log("[LoadingScreen]페이드인 완료");
                OnFadeInCompleted?.Invoke(); // 이 패널이 완전히 나타난 후 이벤트 발생
            });
        currentSequence.AppendCallback(() =>
        {
            stageInfoPanel.alpha = 1f; // 페이드인 후 인포 패널 등장
        });

        // 시퀀스 실행
        StartCoroutine(WaitStageManagerAndPlaySequence());
    }
```
> 여기서 위의 `Initialize()`는 잘 동작하지 않는 반면 아래의 `Initialize()`는 잘 동작함

- 차이점이라면 아래의 `Initialize`는 스테이지 매니저의 초기화를 기다린 다음 실행된다는 것임

1. **로딩 화면의 페이드인은 버튼을 누른 시점에 진행**되어야 함 
	- 이건 **다음 씬의 로드 완료 후에 동작해야 하는가? 와는 완전히 별개**임
2. 현재 발생 중인 문제점은 시퀀스를 설정하고 곧바로 실행하면 페이드인이 진행되지 않고, 기다리는 시간이 있다면 페이드인이 진행되는 방식

- 그러면 그냥 **한 프레임 기다리고 실행**시켜보자.
```cs
private IEnumerator WaitMomentAndplay()
{
	yield return null;
	currentSequence.Play();
}
```
> 안된다. 

- **`Time.timeScale`의 영향일 가능성이 있다**고 함
	- **이거였다.** 아 ㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋㅋ
	- `SetUpdate(true)`를 추가로 달아주는 방법도 있지만
	- 씬 전환은 시간 스케일에 영향을 받기 떄문에 전환하기 시작하는 시점에 1로 설정해주는 게 좋음 -> `LoadScene`의 시작 부분에서 `Time.timeScale = 1f`을 설정해준다

## TimeManager 제거
- `Time` 클래스의 메서드로 다 처리가 가능한 부분이라 굳이 별도로 `TimeManager`를 둘 필요는 없어보임

## StageSelectPanel의 DetailPanel 애니메이션 추가
- 기존엔 단순히 `SetActive`로 활성화 / 비활성화로만 구현했는데 애니메이션을 추가해서 오른쪽에서 왼쪽으로 슬라이드되듯이 나타나게 하고 싶음
- 구현 완료. 이제 디테일 패널은 항상 활성화되어 있으며, 최초에는 화면 밖에 있다가 활성화되면 화면에 나타나는 방식임
	- 빈 공간을 클릭해서 초기화하는 기능은 `StageButtonContainer`에 이미 `Button`으로 구현되어 있음
	- 그 외에 `StageSelectPanel` 스크립트에서 쓸데없어 보이는 구현들을 제거해둠

## OperatorInventoryPanel - 스쿼드 편집 X 시
- 하단 버튼 레이아웃 이상한 현상 수정
	- 필요없는 버튼들의 비활성화 외에도, 중간 공간`Empty`도 비활성화 해줘야 함
	- 완료

## 패널 전환 페이드 시간 증가
- 인벤토리 패널 -> 오퍼레이터 디테일 패널 진입 시 이전 패널이 계속 남아서 이상해보임
- 패널 전환 로직을 수정함
	- 기존에는 새로운 패널을 페이드인 한 다음 기존 패널을 비활성화했음
	- 지금은 **기존 패널을 비활성화한 후에 페이드인**함

### 추가
- 패널 전환 로직을 1개로 통일함 : `FadeInAndHide`
	- 이름을 `ChangePanel`로 변경
- 크게 어색해보이는 게 없어서 이렇게 진행함

## 오늘의 팁
>[!note]
>1. `SceneManager.SceneLoaded`와 `AsyncOperation`의 관계
>- `AsyncOperation.isDone`이 완료되기 직전에 `SceneLoaded` 이벤트가 호출된다. 



# 251104 - 짭명방

>[!done]
>- 기타 수정
>	- `vfx_hit_explode_v1` : 늦게 떨어지는 파티클들이 어색해보임

>[!wip]
>1. 스테이지 씬 -> 메인메뉴 씬 전환

## 스테이지 씬 -> 메인메뉴 씬 장면 전환
- 똑같이 페이드아웃 후 메인 화면 나타나도록 하면 됨

- **아예 `StageLoader`를 `SceneLoader`로 변경함**
	- 씬 전환 과정을 처리
	- 단 스테이지 로딩 화면과 메인 메뉴로 돌아가는 화면은 달라질 듯
- `StageLoadingScreen`도 `LoadingScreen`으로 변경
	- 초기화 메서드를 2개로 구현한다
		- 기존의 `stageId, stageName`이 있는 방식과 아무 파라미터도 전달하지 않는 방식

> [!info]
> **메서드 이름에 관한 고민**을 해봄
> 	1. `Initialize(param1 param)`과 `Initialize()`
> 	2. `InitializeForPurpose(param1 param)`과 `Initialize()`
> 
> 더 권장되는 방법은 1번이라고 함 - **메서드 이름에 목적이 들어가는 게 권장되진 않음**
> - **메서드 이름은 "무엇을 하는가"에만 초점**을 맞추는 게 좋다. "어떻게 하는가" 혹은 "어떤 목적을 위해 작성되었는가" 등이 들어가면 **비슷한 기능의 메서드가 다른 이름으로 계속 늘어나게 된다.** 
> - 대표적인 예시가 `Debug.Log()`인데, 이 메서드는 `string, int, Vector3` 모두 같은 메서드 이름으로 처리한다. 
> 	- 만약 내가 고민한 2번 방법대로 처리한다면 `Debug.LogString()`, `Debug.LogInt()`, `Debug.LogVector3()` 같이 똑같은 기능을 수행함에도 타입이 달라진다는 이유로 다른 메서드가 있다는 걸 알아야 함. 
> - **개발자가 기억할 메서드의 이름이 적을수록 좋다.**
> 
> - 물론 명백히 다른 기능을 수행한다면 메서드 이름을 구분하는 게 좋다. `FadeIn`, `FadeOut`같이 명확히 차이가 있는 기능을 굳이 `DoScreenEffect(EffectType.FadeIn)` 같은 느낌으로 하나의 메서드로 처리하는 건 오히려 가독성을 해칠 수 있다. 

>[!conclusion]
>- 따라서 `StageLoadingScreen`의 경우, 
>	- **`Initialize()`** :  스테이지 로딩 화면에 필요한 정보들인 스테이지 ID, 이름을 불러오지 않고 **검은 화면의 페이드인만 처리**하는 방식
>	- **`Initialize(stageId, stageName)`** : **스테이지 정보들과 로딩 게이지를 함께 보여주는 방식**

> - 일단 `SceneLoader`에서 다른 씬으로 전환하는 방식으로 메서드 수정은 완료 
> - 스테이지 -> 메인메뉴로 돌아갈 때의 페이드인은 나타나지 않고 있음
- `SceneLoader`에서 페이드인이 진행되고, 완료됐을 때 플래그 상태값이 초기화되지 않은 이슈였던 걸로 보임

- **근데 화면이 안 나타난다.** 전환마다 패널을 인스턴스화하는 방식인데, 애니메이션이 동작하지 않는 건가?

> 일단 여기까지 진행

## 기타 수정 사항 
### VFX_Hit_Explode_v1 수정
- 텍스쳐 시트로 바꾸고 나서 `Beam`의 텍스쳐인 18번을 써야 하는데 6번을 쓰고 있었다. `Impact`인데, 작아서 티가 안났음
- 파티클의 타이밍이 이상해보여서 수정.





# 251103 - 짭명방

## 스테이지 진입 버튼 누를 때 장면 전환
- 스테이지 시작 버튼을 누르면 **화면이 완전히 어두워진 다음에 로딩화면이 나타나도록** 수정

> 1. 처음에는 별도의 `FadeScreen`을 만드는 방식으로 접근
> 	- 이 방법이 겉으로 봤을 때는 가장 깔끔해보인다. `스테이지 진입 버튼 클릭 -> 화면 페이드아웃 -> 스테이지 로딩 현황 -> 완료 -> 스테이지 진입` 과정이 크게 거슬리지 않고 깔끔하게 보임
> 	- 근데 `StageLoadingScreen`이랑 일일이 설정을 맞춰야 하는 번거로움이 있는 듯.
> 2. `StageLoadingScreen`으로 통합해서 진행할 수 있을 것 같아서 다시 접근
> 	- 현재까지는 로딩 패널이 씬 전환 후에 나타나서 페이드 아웃/인이 이상함

>[!objective]
>1. 스테이지 진입 버튼을 누르면 페이드 아웃됨
>2. 씬 로딩을 시작하면 검은 화면에 스테이지 로딩 화면이 나타남
>3. 스테이지 로딩이 완료되면 완료 표시가 나온 후 1초 후에 게임이 시작되며 로딩 패널이 페이드아웃됨

### 해결
- 페이드 인이 완료되는 시점까지 로딩을 막는 방식. `yield return new WaitUntil()`

- `StageLoader.cs`
```cs
private IEnumerator LoadStage()
{
	// ...
	
	// 로딩 화면 보여주기 및 입력 차단
	ShowLoadingScreen();

	// 페이드 인 완료 이벤트를 구독함
	// 메서드는 bool 필드를 true로 바꿔주는 단순한 역할
	if (loadingScreen != null) loadingScreen.OnFadeInCompleted += HandleFadeInComplete;

	// 페이드 인 완료까지 대기
	yield return new WaitUntil(() => isFadeInCompleted);

	// 이벤트 구독 해제
	if (loadingScreen != null) loadingScreen.OnFadeInCompleted -= HandleFadeInComplete;
	
	// ...
}
```

- `StageLoadingScreen.cs`
```cs
public event Action OnFadeInCompleted = delegate { }; // 이 스크린의 페이드인 동작이 완료되었을 때 발생

public void Initialize(string stageId, string stageName)
{
	// ...
	
	// 어두운 패널이 서서히 나타남 - Append 개념은 순차적으로 동작함
	currentSequence = DOTween.Sequence();
	currentSequence.Append(screenFader.DOFade(1f, fadeOutDuration))
		.OnComplete(() =>
		{
			// 이 패널이 완전히 나타난 후 이벤트 발생
			OnFadeInCompleted?.Invoke();
		});
	currentSequence.AppendCallback(() =>
	{
		infoPanel.alpha = 1f;
	});
	
	// ...
}
```

### 기타 이슈
 - [x] 2번째 스테이지 진입부터는 `StageLoadingScreen`이 원하는 대로 동작하지 않음
	- [x] 로딩 화면이 페이드인되지 않음 : `StageLoader`의 상태 이슈
	- [x] 로딩 화면 현황이 텍스트로 나타나지 않음 
		- 해결 시도들
			1) 캔버스 강제 업데이트 - 해결 X
				- 로그를 찍어보면 값들은 제대로 나타나고 있음. 
			2) ★ `LoadingScreen`이 실행 시마다 생성되는 현상과 연관이 있을 듯 해서 그 문제부터 접근
				- `LoadingScreen`을 생성하는 부분은 `LoadStage` 내부로 통합
		- `DontDestroyOnLoad`에 `LoadingScreen`이 쌓이는 현상
			- 이것도 해결됨 - 로딩 화면의 게이지가 업데이트되지 않고 텍스트도 나타나지 않는 현상은 이것과 직접적으로 관계가 있었음
- [x] 스테이지 진입은 되는데 여러 UI가 초기화가 제대로 안 됨
	- 로딩 시퀀스 정리
		- `StageLoadingScreen`과 `StageManager`의 타이밍들을 정리할 필요가 있어보인다. 다시 봤을 때 구조가 헷갈림.
			1. `StageLoader` - `loadingScreen`을 초기화함
			2. 초기화가 완료될 때까지 `StageLoader`에서는 대기.
				- 참고) `asyncLoad.isDone`이 `true`라면 새로운 씬의 활성 오브젝트의 모든 `Awake`까지 실행됐다는 얘기임
					- [[Unity - 씬 전환]] 참고
	- 시퀀스 정리는 됐는데 UI 초기화가 안된다. 적의 전체 수라든가, 배치 가능한 횟수라든가.
		- 이건 타이밍 문제 - `StageManager`에 값들이 할당된 다음에 `UI`로 전달해야 하는데 `UI` 초기화 시점이 `StageManager`의 변수 초기화 시점보다 앞서 있었음.
